<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>笔记</title>
  
  <subtitle>以每一个问题为目标，每解决一个问题给自己及时反馈</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://blog.wjc66.cn/"/>
  <updated>2022-09-08T09:15:31.269Z</updated>
  <id>https://blog.wjc66.cn/</id>
  
  <author>
    <name>w-klover</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>记一次使用redis的keys命令导致redis雪崩的生产事故</title>
    <link href="https://blog.wjc66.cn/%E8%AE%B0%E4%B8%80%E6%AC%A1%E4%BD%BF%E7%94%A8redis%E7%9A%84keys%E5%91%BD%E4%BB%A4%E5%AF%BC%E8%87%B4redis%E9%9B%AA%E5%B4%A9%E7%9A%84%E7%94%9F%E4%BA%A7%E4%BA%8B%E6%95%85/"/>
    <id>https://blog.wjc66.cn/%E8%AE%B0%E4%B8%80%E6%AC%A1%E4%BD%BF%E7%94%A8redis%E7%9A%84keys%E5%91%BD%E4%BB%A4%E5%AF%BC%E8%87%B4redis%E9%9B%AA%E5%B4%A9%E7%9A%84%E7%94%9F%E4%BA%A7%E4%BA%8B%E6%95%85/</id>
    <published>2022-09-08T09:00:31.000Z</published>
    <updated>2022-09-08T09:15:31.269Z</updated>
    
    <content type="html"><![CDATA[<h2 id="出现原因"><a href="#出现原因" class="headerlink" title="出现原因"></a>出现原因</h2><p>由于需要每时每刻监听三方报错超过十次发送机器人警告，所以每次报错我这边就存入一个（key+时间），同时过期时间为1小时，所以查询当前的一个小时内错误次数，使用 <code>keys key*</code>查询key的数量，就知道错误次数，本来一直没有问题，跑了大半年了，突然有一天redis的cpu100%，直接雪崩，导致客户无法登录，后面排查原因是有个三方一直报错，代码又重试，由于需要机器人提醒(这个时候我们redis key已经超过80w个key),导致一秒钟查上千次询<code>keys</code>命令，最后redis直接爆炸。</p><a id="more"></a><h2 id="官方对keys这个命令的说明"><a href="#官方对keys这个命令的说明" class="headerlink" title="官方对keys这个命令的说明"></a>官方对keys这个命令的说明</h2><p>keys的时间复杂度是O(N)，N为执行该命令下的数据库的key的数量，常数。<br>redis扫描key的速度很快，在入门笔记本大约是40毫秒100w个。<br>警告⚠️：keys用在生产环境只能以极低频率执行。 在大数据库执行时会出现灾难性的性能。如果需要查询某些key，考虑使用SCAN或者sets。</p><h2 id="keys命令为什么会这么慢呢？"><a href="#keys命令为什么会这么慢呢？" class="headerlink" title="keys命令为什么会这么慢呢？"></a>keys命令为什么会这么慢呢？</h2><p>(1) Redis是NoSQL型数据库，以hash数据结构存储的，所以才能实现高效的数据查询。而hash结构对于精确查找是非常快的，对于模糊查询，则无能为力。<br>(2) Redis的命令执行是单线程的，同一时间只能执行单个命令。单一长时间命令会堵塞后续。(可以通过debug sleep 0.1100ms 模拟执行长时间命令)<br>以上两点造成了KEYS进行key查询需要遍历当前db的所有数据，以及当该命令执行完成的时候后续命令都会被堵塞。<br>因此在redis中执行的命令，尽量避免长时间堵塞命令。</p><h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>后面实在没有办法退而求其次，把所有的<code>keys</code>命令移除了，只是简单记录次数了，一直自己自增，半个小时自动过期。还有一种方法就是保存数据库，每进来一条错误日志，就保存一次，按照时间查询这样也可以达到上面的效果，每天或者每月去清理之前的旧数据，防止数据太多。</p><p>看网上推荐使用<code>Scan</code>来替换<code>keys</code>，它是增量地迭代 ，它们每次执行都只会返回少量元素，不会阻塞服务器， 所以这些命令可以用于生产环境， 而不会出现像 KEYS 命令、 SMEMBERS 命令带来的问题。但是会出现.同一个元素可能会被返回多次，所以就没有使用。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;出现原因&quot;&gt;&lt;a href=&quot;#出现原因&quot; class=&quot;headerlink&quot; title=&quot;出现原因&quot;&gt;&lt;/a&gt;出现原因&lt;/h2&gt;&lt;p&gt;由于需要每时每刻监听三方报错超过十次发送机器人警告，所以每次报错我这边就存入一个（key+时间），同时过期时间为1小时，所以查询当前的一个小时内错误次数，使用 &lt;code&gt;keys key*&lt;/code&gt;查询key的数量，就知道错误次数，本来一直没有问题，跑了大半年了，突然有一天redis的cpu100%，直接雪崩，导致客户无法登录，后面排查原因是有个三方一直报错，代码又重试，由于需要机器人提醒(这个时候我们redis key已经超过80w个key),导致一秒钟查上千次询&lt;code&gt;keys&lt;/code&gt;命令，最后redis直接爆炸。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="redis" scheme="https://blog.wjc66.cn/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>postgresql事务死锁和连接池数不够导致node项目假死</title>
    <link href="https://blog.wjc66.cn/postgresql%E4%BA%8B%E5%8A%A1%E6%AD%BB%E9%94%81%E5%92%8C%E8%BF%9E%E6%8E%A5%E6%B1%A0%E6%95%B0%E4%B8%8D%E5%A4%9F%E5%AF%BC%E8%87%B4node%E9%A1%B9%E7%9B%AE%E5%81%87%E6%AD%BB/"/>
    <id>https://blog.wjc66.cn/postgresql%E4%BA%8B%E5%8A%A1%E6%AD%BB%E9%94%81%E5%92%8C%E8%BF%9E%E6%8E%A5%E6%B1%A0%E6%95%B0%E4%B8%8D%E5%A4%9F%E5%AF%BC%E8%87%B4node%E9%A1%B9%E7%9B%AE%E5%81%87%E6%AD%BB/</id>
    <published>2022-09-08T08:01:35.000Z</published>
    <updated>2022-09-08T08:59:19.937Z</updated>
    
    <content type="html"><![CDATA[<h2 id="出现原因"><a href="#出现原因" class="headerlink" title="出现原因"></a>出现原因</h2><p>客户量起来，创建订单越来越多，因为之前是用typeOrm的默认配置，看了源码，发现默认配置是10，所以导致客户请求不了。后来解决了连接池问题，又出现数据库死锁，导致数据库cpu直接100%，又导致客户订单创建不了，产生生产损失。</p><a id="more"></a><h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><h3 id="线索池问题"><a href="#线索池问题" class="headerlink" title="线索池问题"></a>线索池问题</h3><ol><li>排查<br>当时出现node程序假死，但是数据库，redis都是正常，后面排查连接数是否正常，发现连接数很少，当时很懵，不知道为啥，后面想到typeorm连接池配置，发现了问题。</li></ol><p>修改typeorm配置</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">keepAlive: <span class="literal">true</span>,</span><br><span class="line">extra: &#123;</span><br><span class="line">  poolSize: <span class="number">800</span>,</span><br><span class="line">  mixins: <span class="number">0</span>,</span><br><span class="line">  connectTimeoutMS: <span class="number">60000</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><ol start="2"><li><p>查询数据库允许的最大连接数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> max_connections;</span><br></pre></td></tr></table></figure></li><li><p>查看当前连接数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 分组求和</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*), usename <span class="keyword">from</span> pg_stat_activity <span class="keyword">group</span> <span class="keyword">by</span> usename;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 总数</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> pg_stat_activity</span><br></pre></td></tr></table></figure></li></ol><h3 id="数据库死锁问题"><a href="#数据库死锁问题" class="headerlink" title="数据库死锁问题"></a>数据库死锁问题</h3><ol><li><p>排查<br>也是因为客户量增加，交易频繁，导致大面积数据库死锁，数据库cpu 100%，影响客户使用，后面百度搜索出现死锁原因，发现原来表加锁顺序问题。</p></li><li><p>什么是数据库死锁<br>在操作系统领域当中，死锁指的是两个或者两个以上的进程在运行的过程中，因为争夺共同的访问资源而相互等待阻塞，最终造成阻碍进程继续执行的一种阻塞现象。那么在数据库领域当中死锁又是怎样的表现形式呢？</p></li></ol><p>如下图所示，假设事务A持有行1的共享锁，事务B持有行2的共享锁，那么此时事务A请求持有行2的排他锁，那么在事务B释放资源之前都处于阻塞等待的状态，同样的事务B请求持有行1的排他锁，在事务A 释放资源之前同样也是处于阻塞等待的状态。也就是说事务 B 完成之后事务 A 才能完成，而事务A的完成又依赖于事务B的完成，这就形成了循环依赖的问题，最终导致死锁情况的发生。</p><p>测试sql 如下（按照步骤执行到第三步就会出现死锁）：<br>sql1:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 执行第一步</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="string">"user"</span> <span class="keyword">where</span> <span class="string">"id"</span> = <span class="string">'03b44ddb-0813-40c2-bbba-5ca51fc2c57f'</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="comment">-- 执行第三步</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="string">"user"</span> <span class="keyword">where</span> <span class="string">"id"</span> = <span class="string">'bfdf2d04-d330-4134-8057-7b77ceaaf8d0'</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><p>sql2:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 执行第二步</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="string">"user"</span> <span class="keyword">where</span> <span class="string">"id"</span> = <span class="string">'bfdf2d04-d330-4134-8057-7b77ceaaf8d0'</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br><span class="line"><span class="comment">-- 执行第四步</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="string">"user"</span> <span class="keyword">where</span> <span class="string">"id"</span> = <span class="string">'03b44ddb-0813-40c2-bbba-5ca51fc2c57f'</span> <span class="keyword">FOR</span> <span class="keyword">UPDATE</span>;</span><br></pre></td></tr></table></figure><ol start="3"><li>死锁排查</li></ol><p>创建视图用于查询死锁</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> v_locks_monitor <span class="keyword">as</span>   </span><br><span class="line"><span class="keyword">with</span>    </span><br><span class="line">t_wait <span class="keyword">as</span>    </span><br><span class="line">(    </span><br><span class="line">  <span class="keyword">select</span> a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.granted,   </span><br><span class="line">  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,    </span><br><span class="line">  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name   </span><br><span class="line">    <span class="keyword">from</span> pg_locks a,pg_stat_activity b <span class="keyword">where</span> a.pid=b.pid <span class="keyword">and</span> <span class="keyword">not</span> a.granted   </span><br><span class="line">),   </span><br><span class="line">t_run <span class="keyword">as</span>   </span><br><span class="line">(   </span><br><span class="line">  <span class="keyword">select</span> a.mode,a.locktype,a.database,a.relation,a.page,a.tuple,a.classid,a.granted,   </span><br><span class="line">  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,   </span><br><span class="line">  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name   </span><br><span class="line">    <span class="keyword">from</span> pg_locks a,pg_stat_activity b <span class="keyword">where</span> a.pid=b.pid <span class="keyword">and</span> a.granted   </span><br><span class="line">),   </span><br><span class="line">t_overlap <span class="keyword">as</span>   </span><br><span class="line">(   </span><br><span class="line">  <span class="keyword">select</span> r.* <span class="keyword">from</span> t_wait w <span class="keyword">join</span> t_run r <span class="keyword">on</span>   </span><br><span class="line">  (   </span><br><span class="line">    r.locktype <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.locktype <span class="keyword">and</span>   </span><br><span class="line">    r.database <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.database <span class="keyword">and</span>   </span><br><span class="line">    r.relation <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.relation <span class="keyword">and</span>   </span><br><span class="line">    r.page <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.page <span class="keyword">and</span>   </span><br><span class="line">    r.tuple <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.tuple <span class="keyword">and</span>   </span><br><span class="line">    r.virtualxid <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.virtualxid <span class="keyword">and</span>   </span><br><span class="line">    r.transactionid <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.transactionid <span class="keyword">and</span>   </span><br><span class="line">    r.classid <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.classid <span class="keyword">and</span>   </span><br><span class="line">    r.objid <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.objid <span class="keyword">and</span>   </span><br><span class="line">    r.objsubid <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">distinct</span> <span class="keyword">from</span> w.objsubid <span class="keyword">and</span>   </span><br><span class="line">    r.pid &lt;&gt; w.pid   </span><br><span class="line">  )    </span><br><span class="line">),    </span><br><span class="line">t_unionall <span class="keyword">as</span>    </span><br><span class="line">(    </span><br><span class="line">  <span class="keyword">select</span> r.* <span class="keyword">from</span> t_overlap r    </span><br><span class="line">  <span class="keyword">union</span> <span class="keyword">all</span>    </span><br><span class="line">  <span class="keyword">select</span> w.* <span class="keyword">from</span> t_wait w    </span><br><span class="line">)    </span><br><span class="line"><span class="keyword">select</span> locktype,datname,relation::regclass,page,tuple,virtualxid,transactionid::<span class="built_in">text</span>,classid::regclass,objid,objsubid,   </span><br><span class="line">string_agg(   </span><br><span class="line"><span class="string">'Pid: '</span>||<span class="keyword">case</span> <span class="keyword">when</span> pid <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> pid::<span class="built_in">text</span> <span class="keyword">end</span>||<span class="keyword">chr</span>(<span class="number">10</span>)||   </span><br><span class="line"><span class="string">'Lock_Granted: '</span>||<span class="keyword">case</span> <span class="keyword">when</span> granted <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> granted::<span class="built_in">text</span> <span class="keyword">end</span>||<span class="string">' , Mode: '</span>||<span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">mode</span> <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> <span class="keyword">mode</span>::<span class="built_in">text</span> <span class="keyword">end</span>||<span class="string">' , FastPath: '</span>||<span class="keyword">case</span> <span class="keyword">when</span> fastpath <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> fastpath::<span class="built_in">text</span> <span class="keyword">end</span>||<span class="string">' , VirtualTransaction: '</span>||<span class="keyword">case</span> <span class="keyword">when</span> virtualtransaction <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> virtualtransaction::<span class="built_in">text</span> <span class="keyword">end</span>||<span class="string">' , Session_State: '</span>||<span class="keyword">case</span> <span class="keyword">when</span> state <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> state::<span class="built_in">text</span> <span class="keyword">end</span>||<span class="keyword">chr</span>(<span class="number">10</span>)||   </span><br><span class="line"><span class="string">'Username: '</span>||<span class="keyword">case</span> <span class="keyword">when</span> usename <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> usename::<span class="built_in">text</span> <span class="keyword">end</span>||<span class="string">' , Database: '</span>||<span class="keyword">case</span> <span class="keyword">when</span> datname <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> datname::<span class="built_in">text</span> <span class="keyword">end</span>||<span class="string">' , Client_Addr: '</span>||<span class="keyword">case</span> <span class="keyword">when</span> client_addr <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> client_addr::<span class="built_in">text</span> <span class="keyword">end</span>||<span class="string">' , Client_Port: '</span>||<span class="keyword">case</span> <span class="keyword">when</span> client_port <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> client_port::<span class="built_in">text</span> <span class="keyword">end</span>||<span class="string">' , Application_Name: '</span>||<span class="keyword">case</span> <span class="keyword">when</span> application_name <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> application_name::<span class="built_in">text</span> <span class="keyword">end</span>||<span class="keyword">chr</span>(<span class="number">10</span>)||    </span><br><span class="line"><span class="string">'Xact_Start: '</span>||<span class="keyword">case</span> <span class="keyword">when</span> xact_start <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> xact_start::<span class="built_in">text</span> <span class="keyword">end</span>||<span class="string">' , Query_Start: '</span>||<span class="keyword">case</span> <span class="keyword">when</span> query_start <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> query_start::<span class="built_in">text</span> <span class="keyword">end</span>||<span class="string">' , Xact_Elapse: '</span>||<span class="keyword">case</span> <span class="keyword">when</span> (<span class="keyword">now</span>()-xact_start) <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> (<span class="keyword">now</span>()-xact_start)::<span class="built_in">text</span> <span class="keyword">end</span>||<span class="string">' , Query_Elapse: '</span>||<span class="keyword">case</span> <span class="keyword">when</span> (<span class="keyword">now</span>()-query_start) <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> (<span class="keyword">now</span>()-query_start)::<span class="built_in">text</span> <span class="keyword">end</span>||<span class="keyword">chr</span>(<span class="number">10</span>)||    </span><br><span class="line"><span class="string">'SQL (Current SQL in Transaction): '</span>||<span class="keyword">chr</span>(<span class="number">10</span>)||  </span><br><span class="line"><span class="keyword">case</span> <span class="keyword">when</span> <span class="keyword">query</span> <span class="keyword">is</span> <span class="literal">null</span> <span class="keyword">then</span> <span class="string">'NULL'</span> <span class="keyword">else</span> <span class="keyword">query</span>::<span class="built_in">text</span> <span class="keyword">end</span>,    </span><br><span class="line"><span class="keyword">chr</span>(<span class="number">10</span>)||<span class="string">'--------'</span>||<span class="keyword">chr</span>(<span class="number">10</span>)    </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span>    </span><br><span class="line">  (  <span class="keyword">case</span> <span class="keyword">mode</span>    </span><br><span class="line">    <span class="keyword">when</span> <span class="string">'INVALID'</span> <span class="keyword">then</span> <span class="number">0</span>   </span><br><span class="line">    <span class="keyword">when</span> <span class="string">'AccessShareLock'</span> <span class="keyword">then</span> <span class="number">1</span>   </span><br><span class="line">    <span class="keyword">when</span> <span class="string">'RowShareLock'</span> <span class="keyword">then</span> <span class="number">2</span>   </span><br><span class="line">    <span class="keyword">when</span> <span class="string">'RowExclusiveLock'</span> <span class="keyword">then</span> <span class="number">3</span>   </span><br><span class="line">    <span class="keyword">when</span> <span class="string">'ShareUpdateExclusiveLock'</span> <span class="keyword">then</span> <span class="number">4</span>   </span><br><span class="line">    <span class="keyword">when</span> <span class="string">'ShareLock'</span> <span class="keyword">then</span> <span class="number">5</span>   </span><br><span class="line">    <span class="keyword">when</span> <span class="string">'ShareRowExclusiveLock'</span> <span class="keyword">then</span> <span class="number">6</span>   </span><br><span class="line">    <span class="keyword">when</span> <span class="string">'ExclusiveLock'</span> <span class="keyword">then</span> <span class="number">7</span>   </span><br><span class="line">    <span class="keyword">when</span> <span class="string">'AccessExclusiveLock'</span> <span class="keyword">then</span> <span class="number">8</span>   </span><br><span class="line">    <span class="keyword">else</span> <span class="number">0</span>   </span><br><span class="line">  <span class="keyword">end</span>  ) <span class="keyword">desc</span>,   </span><br><span class="line">  (<span class="keyword">case</span> <span class="keyword">when</span> granted <span class="keyword">then</span> <span class="number">0</span> <span class="keyword">else</span> <span class="number">1</span> <span class="keyword">end</span>)  </span><br><span class="line">) <span class="keyword">as</span> lock_conflict  </span><br><span class="line"><span class="keyword">from</span> t_unionall   </span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span>   </span><br><span class="line">locktype,datname,relation,page,tuple,virtualxid,transactionid::<span class="built_in">text</span>,classid,objid,objsubid ;</span><br></pre></td></tr></table></figure><p>执行视图,会出现死锁信息，如下图</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> v_locks_monitor</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/37e2d4b32f6e4b63b05157df55a11aad.png" alt="在这里插入图片描述"></p><p>找到”被阻塞者”,找到pid,如下图</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> pid <span class="keyword">from</span> pg_locks <span class="keyword">where</span> <span class="keyword">not</span> granted;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/33656d7f091e4625bcee064516bcc251.png" alt="在这里插入图片描述"></p><p>找到”阻塞者”,可以找到执行的sql,如下图</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> pg_stat_activity <span class="keyword">where</span> pid=<span class="number">5432</span>;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/f05e9f0a778040118c656086e9ce631e.png" alt="在这里插入图片描述"></p><p>杀死当前死锁</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> pg_terminate_backend(<span class="number">5432</span>);</span><br></pre></td></tr></table></figure><h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p>修改正常加锁的顺序之后，就没有出现当前问题了。</p><h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p><a href="https://blog.csdn.net/diamond_tao/article/details/124567168" target="_blank" rel="external nofollow noopener noreferrer">PostgreSQL死锁了怎么办？</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;出现原因&quot;&gt;&lt;a href=&quot;#出现原因&quot; class=&quot;headerlink&quot; title=&quot;出现原因&quot;&gt;&lt;/a&gt;出现原因&lt;/h2&gt;&lt;p&gt;客户量起来，创建订单越来越多，因为之前是用typeOrm的默认配置，看了源码，发现默认配置是10，所以导致客户请求不了。后来解决了连接池问题，又出现数据库死锁，导致数据库cpu直接100%，又导致客户订单创建不了，产生生产损失。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="postgresql" scheme="https://blog.wjc66.cn/tags/postgresql/"/>
    
  </entry>
  
  <entry>
    <title>使用pm2启动node项目，内存直接暴增,原因是高IO读写</title>
    <link href="https://blog.wjc66.cn/%E4%BD%BF%E7%94%A8pm2%E5%90%AF%E5%8A%A8node%E9%A1%B9%E7%9B%AE%EF%BC%8C%E5%86%85%E5%AD%98%E7%9B%B4%E6%8E%A5%E6%9A%B4%E5%A2%9E,%E5%8E%9F%E5%9B%A0%E6%98%AF%E9%AB%98IO%E8%AF%BB%E5%86%99/"/>
    <id>https://blog.wjc66.cn/%E4%BD%BF%E7%94%A8pm2%E5%90%AF%E5%8A%A8node%E9%A1%B9%E7%9B%AE%EF%BC%8C%E5%86%85%E5%AD%98%E7%9B%B4%E6%8E%A5%E6%9A%B4%E5%A2%9E,%E5%8E%9F%E5%9B%A0%E6%98%AF%E9%AB%98IO%E8%AF%BB%E5%86%99/</id>
    <published>2022-09-08T07:36:07.000Z</published>
    <updated>2022-09-09T02:40:44.973Z</updated>
    
    <content type="html"><![CDATA[<ol><li>出现原因介绍<br>因为我们使用了神策埋点，正好神策过期了，没有及时关闭配置，导致日志上传不了，一直保存在本地，存了上百M的日志，在代码发布的时候需要重启，导致pm2的内容直接超过8G,把服务器直接卡死，等了半个小时了之后 内存慢慢下降，刚开始以为是代码太多，打包内存不够用，升级了服务器内存，还是出现了同样的问题，排查了几天都没有发现。后面使用<code>node-tick</code>才发现原因是神策在上传日志，他里面写的是foreach循环一起上传所有日志，由于有上传不了，又保存在本地。</li></ol><a id="more"></a><ol start="2"><li><p>问题排查<br>安装node-tick方式<code>sudo npm -g install tick</code><br>使用启用的配置文件运行您的应用程序<code>node --prof app.js</code><br>在 CPU 100% 使用一段时间后停止您的应用程序<br>您可以在您的应用目录中看到 v8.log，现在您可以使用 <code>node-tick-processor isolate-0x5138fd0-15431-v8.log</code> 读取它,直接看。但是不方便，推荐直接第3步，存入文件看</p></li><li><p>解析到文件中，查看堆栈信息</p><blockquote><p><code>node --prof-process isolate-0x102884000-14025-v8.log &gt; 11.txt</code></p></blockquote></li></ol><ol start="4"><li>实例 创建一个app.js文件<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        ++i</span><br><span class="line">        <span class="built_in">console</span>.log(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure></li></ol><p>执行当前文件 <code>node --prof app.js</code> 跑到cpu特别高的时候 关闭，就会生成一个日志文件<code>isolate-0x102884000-14025-v8.log</code>(文件名字会不一样)；</p><p>解析到文件中 <code>node --prof-process isolate-0x102884000-14025-v8.log &gt; 11.txt</code>;</p><p>查看文件 找到对应的执行的地方</p><p><img src="https://img-blog.csdnimg.cn/5aa3fa4721b146c8a6bb4878b708b7ff.png" alt="在这里插入图片描述"></p><h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><p>感谢梁老师让我学习到如果排查此问题！！！</p><h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p><a href="http://t.zoukankan.com/flydean-p-14376230.html" target="_blank" rel="external nofollow noopener noreferrer">使用V8和node轻松profile分析nodejs应用程序</a></p><p><a href="https://itecnote.com/tecnote/r-how-to-debug-node-js-causing-100-cpu-usage/" target="_blank" rel="external nofollow noopener noreferrer">Node.js – how to debug node.js causing 100% cpu usage</a></p>]]></content>
    
    <summary type="html">
    
      &lt;ol&gt;
&lt;li&gt;出现原因介绍&lt;br&gt;因为我们使用了神策埋点，正好神策过期了，没有及时关闭配置，导致日志上传不了，一直保存在本地，存了上百M的日志，在代码发布的时候需要重启，导致pm2的内容直接超过8G,把服务器直接卡死，等了半个小时了之后 内存慢慢下降，刚开始以为是代码太多，打包内存不够用，升级了服务器内存，还是出现了同样的问题，排查了几天都没有发现。后面使用&lt;code&gt;node-tick&lt;/code&gt;才发现原因是神策在上传日志，他里面写的是foreach循环一起上传所有日志，由于有上传不了，又保存在本地。&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
    
    
      <category term="nodejs" scheme="https://blog.wjc66.cn/tags/nodejs/"/>
    
  </entry>
  
  <entry>
    <title>CPU偶现的100%查询</title>
    <link href="https://blog.wjc66.cn/CPU%E5%81%B6%E7%8E%B0%E7%9A%84100-%E6%9F%A5%E8%AF%A2/"/>
    <id>https://blog.wjc66.cn/CPU%E5%81%B6%E7%8E%B0%E7%9A%84100-%E6%9F%A5%E8%AF%A2/</id>
    <published>2022-09-08T07:19:24.000Z</published>
    <updated>2022-09-08T07:24:17.315Z</updated>
    
    <content type="html"><![CDATA[<p>在服务器偶然会出现CPU100%时，会出现服务器对外不可用，健康检查也无法相应。</p><blockquote><p>因为是偶现，一般重启后就好了。但是这种时候一般先不要重启，先按如下命令：</p></blockquote><a id="more"></a><h2 id="1-找出node-js-的进程号-top"><a href="#1-找出node-js-的进程号-top" class="headerlink" title="1. 找出node.js 的进程号: top"></a>1. 找出node.js 的进程号: top</h2><p><img src="https://img-blog.csdnimg.cn/08b679d2b3b54662914727f5c9dfbbd0.png" alt="在这里插入图片描述"></p><h2 id="2-进入调试状态：node-inspect-p-pid"><a href="#2-进入调试状态：node-inspect-p-pid" class="headerlink" title="2. 进入调试状态：node inspect -p pid"></a>2. 进入调试状态：node inspect -p pid</h2><p>例如：<code>node inspect -p 22056</code>，你会看到这个提示：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">debug&gt;</span><br></pre></td></tr></table></figure><h2 id="3-然后输入：pause"><a href="#3-然后输入：pause" class="headerlink" title="3. 然后输入：pause"></a>3. 然后输入：pause</h2><p><img src="https://img-blog.csdnimg.cn/e1d8728b0d5b4977b47172834363c266.png" alt="在这里插入图片描述"></p><p>就能找到，当前执行的代码块</p><h2 id="4-根据提示找出对应行的代码"><a href="#4-根据提示找出对应行的代码" class="headerlink" title="4. 根据提示找出对应行的代码"></a>4. 根据提示找出对应行的代码</h2><p><img src="https://img-blog.csdnimg.cn/bccb3c625d094dcd8dd7b6d3f5d6e710.png" alt="在这里插入图片描述"></p><h2 id="感谢"><a href="#感谢" class="headerlink" title="感谢"></a>感谢</h2><p>感谢梁老师让我学习到如果排查此问题！！！</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在服务器偶然会出现CPU100%时，会出现服务器对外不可用，健康检查也无法相应。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;因为是偶现，一般重启后就好了。但是这种时候一般先不要重启，先按如下命令：&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
    
      <category term="nodejs" scheme="https://blog.wjc66.cn/tags/nodejs/"/>
    
  </entry>
  
  <entry>
    <title>postgresql日期相关函数</title>
    <link href="https://blog.wjc66.cn/postgresql%E6%97%A5%E6%9C%9F%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0/"/>
    <id>https://blog.wjc66.cn/postgresql%E6%97%A5%E6%9C%9F%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0/</id>
    <published>2022-09-08T06:35:24.000Z</published>
    <updated>2022-09-08T07:06:57.659Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Postgresql中string转换成timestamp类型"><a href="#Postgresql中string转换成timestamp类型" class="headerlink" title="Postgresql中string转换成timestamp类型"></a>Postgresql中string转换成timestamp类型</h2><p>Mybatis+Postgresql<br><code>TO_DATE(#{startTime}, &#39;YYYY-MM-DD&#39;)</code></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AND op_date &lt;![CDATA[&gt;= ]]&gt;  TO_TIMESTAMP(#&#123;beginTime&#125;, 'YYYY-MM-DD HH24:MI:SS')</span><br><span class="line">AND op_date &lt;![CDATA[&lt;= ]]&gt;  TO_TIMESTAMP(#&#123;endTime&#125;, 'YYYY-MM-DD HH24:MI:SS')</span><br></pre></td></tr></table></figure><p>而页面要接收和传递数据需要在javaBean中写如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonFormat</span>(pattern=<span class="string">"yyyy-MM-dd HH:mm:ss"</span>,timezone = <span class="string">"GMT+8"</span>)</span><br><span class="line"><span class="keyword">private</span> Timestamp opDate;        <span class="comment">//操作日期</span></span><br></pre></td></tr></table></figure><h2 id="PostgreSQL日期加减"><a href="#PostgreSQL日期加减" class="headerlink" title="PostgreSQL日期加减"></a>PostgreSQL日期加减</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">now</span>()::<span class="built_in">timestamp</span> + <span class="string">'1 year'</span>;  <span class="comment">--当前时间加1年</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">now</span>()::<span class="built_in">timestamp</span> + <span class="string">'1 month'</span>;  <span class="comment">--当前时间加一个月</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">now</span>()::<span class="built_in">timestamp</span> + <span class="string">'1 day'</span>;  <span class="comment">--当前时间加一天</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">now</span>()::<span class="built_in">timestamp</span> + <span class="string">'1 hour'</span>;  <span class="comment">--当前时间加一个小时</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">now</span>()::<span class="built_in">timestamp</span> + <span class="string">'1 min'</span>;  <span class="comment">--当前时间加一分钟</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">now</span>()::<span class="built_in">timestamp</span> + <span class="string">'1 sec'</span>;  <span class="comment">--加一秒钟</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">select</span> <span class="keyword">now</span>()::<span class="built_in">timestamp</span> + <span class="string">'1 year 1 month 1 day 1 hour 1 min 1 sec'</span>;  <span class="comment">--加1年1月1天1时1分1秒</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">now</span>()::<span class="built_in">timestamp</span> + (<span class="keyword">col</span> || <span class="string">' day'</span>)::<span class="built_in">interval</span> <span class="keyword">FROM</span> <span class="keyword">table</span> <span class="comment">--把col字段转换成天 然后相加</span></span><br></pre></td></tr></table></figure><h2 id="PostgreSQL常用当前时间"><a href="#PostgreSQL常用当前时间" class="headerlink" title="PostgreSQL常用当前时间"></a>PostgreSQL常用当前时间</h2><p>PostgreSQL 提供可许多返回当前日期和时间的函数。部分函数按照当前事务的开始时刻返回结果：</p><p>CURRENT_TIME(precision)<br>transaction_timestamp() 感觉这个描述更符合实际情况</p><p>另外部分函数返回实时时间值，在事务中也会随时间变化。<br>statement_timestamp()<br>clock_timestamp()<br>timeofday() 返回的是text字符串</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="string">''</span>||<span class="keyword">now</span>()::<span class="built_in">timestamp</span> <span class="comment">-- 2022-02-25 14:29:00.189944</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">substring</span>(<span class="string">''</span>||<span class="keyword">now</span>()::<span class="built_in">timestamp</span> <span class="keyword">from</span> <span class="number">1</span> <span class="keyword">for</span> <span class="number">19</span>)  <span class="comment">--  2022-02-25 14:25:44</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">now</span>() <span class="comment">-- 2022-02-25 14:48:35</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">localtime</span> <span class="comment">-- 14:47:08</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">localtimestamp</span> <span class="comment">-- 2022-02-25 14:47:08</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">current_date</span> <span class="comment">--  2022-02-25</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">current_time</span> <span class="comment">--  14:29:13</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">current_timestamp</span> <span class="comment">-- 2022-02-25 14:45:03</span></span><br><span class="line"><span class="keyword">select</span>  to_char(<span class="keyword">now</span>(), <span class="string">'YYYY-MM-DD HH24:mi:ss:ms'</span>) <span class="comment">--  2022-02-25 14:35:06:569</span></span><br><span class="line"><span class="keyword">select</span> timeofday() <span class="comment">-- 返回的是text字符串,Fri Feb 25 14:43:46.005910 2022 CST</span></span><br><span class="line">此外，还有<span class="keyword">CURRENT_TIME</span>(<span class="keyword">precision</span>)， statement_timestamp()， clock_timestamp()</span><br></pre></td></tr></table></figure><h2 id="PostgreSQL的时间类型"><a href="#PostgreSQL的时间类型" class="headerlink" title="PostgreSQL的时间类型"></a>PostgreSQL的时间类型</h2><h3 id="类型转换函数"><a href="#类型转换函数" class="headerlink" title="类型转换函数"></a>类型转换函数</h3><p>PostgreSQL格式化函数提供一套有效的工具用于把各种数据类型(日期/时间、integer、floating point和numeric)转换成格式化的字符串以及反过来从格式化的字符串转换成指定的数据类型。下面列出了这些函数，它们都遵循一个公共的调用习惯：第一个参数是待格式化的值，而第二个是定义输出或输出格式的模板。</p><table><thead><tr><th>函数</th><th>返回类型</th><th>描述</th><th>例子</th></tr></thead><tbody><tr><td>to_char(timestamp, text)</td><td>text</td><td>把时间戳转换成字串</td><td>to_char(current_timestamp, ‘HH12:MI:SS’)</td></tr><tr><td>to_char(interval, text)</td><td>text</td><td>把时间间隔转为字串</td><td>to_char(interval ‘15h 2m 12s’, ‘HH24:MI:SS’)</td></tr><tr><td>to_char(int, text)</td><td>text</td><td>把整数转换成字串</td><td>to_char(125, ‘999’)</td></tr><tr><td>to_char(double precision, text)</td><td>text</td><td>把实数/双精度数转换成字串</td><td>to_char(125.8::real, ‘999D9’)</td></tr><tr><td>to_char(numeric, text)</td><td>text</td><td>把numeric转换成字串</td><td>to_char(-125.8, ‘999D99S’)</td></tr><tr><td>to_date(text, text)</td><td>date</td><td>把字串转换成日期</td><td>to_date(‘05 Dec 2000’, ‘DD Mon YYYY’)</td></tr><tr><td>to_timestamp(text, text)</td><td>timestamp</td><td>把字串转换成时间戳</td><td>to_timestamp(‘05 Dec 2000’, ‘DD Mon YYYY’)</td></tr><tr><td>to_timestamp(double)</td><td>timestamp</td><td>把UNIX纪元转换成时间戳</td><td>to_timestamp(200120400)</td></tr><tr><td>to_number(text, text)</td><td>numeric</td><td>把字串转换成numeric</td><td>to_number(‘12,454.8-‘, ‘99G999D9S’)</td></tr></tbody></table><h3 id="日期-时间格式化的模式"><a href="#日期-时间格式化的模式" class="headerlink" title="日期/时间格式化的模式"></a>日期/时间格式化的模式</h3><table><thead><tr><th>模式</th><th>描述</th></tr></thead><tbody><tr><td>HH</td><td>一天的小时数(01-12)</td></tr><tr><td>HH12</td><td>一天的小时数(01-12)</td></tr><tr><td>HH24</td><td>一天的小时数(00-23)</td></tr><tr><td>MI</td><td>分钟(00-59)</td></tr><tr><td>SS</td><td>秒(00-59)</td></tr><tr><td>MS</td><td>毫秒(000-999)</td></tr><tr><td>US</td><td>微秒(000000-999999)</td></tr><tr><td>AM</td><td>正午标识(大写)</td></tr><tr><td>Y,YYY</td><td>带逗号的年(4和更多位)</td></tr><tr><td>YYYY</td><td>年(4和更多位)</td></tr><tr><td>YYY</td><td>年的后三位</td></tr><tr><td>YY</td><td>年的后两位</td></tr><tr><td>Y</td><td>年的最后一位</td></tr><tr><td>MONTH</td><td>全长大写月份名(空白填充为9字符)</td></tr><tr><td>Month</td><td>全长混合大小写月份名(空白填充为9字符)</td></tr><tr><td>month</td><td>全长小写月份名(空白填充为9字符)</td></tr><tr><td>MON</td><td>大写缩写月份名(3字符)</td></tr><tr><td>Mon</td><td>缩写混合大小写月份名(3字符)</td></tr><tr><td>mon</td><td>小写缩写月份名(3字符)</td></tr><tr><td>MM</td><td>月份号(01-12)</td></tr><tr><td>DAY</td><td>全长大写日期名(空白填充为9字符)</td></tr><tr><td>Day</td><td>全长混合大小写日期名(空白填充为9字符)</td></tr><tr><td>day</td><td>全长小写日期名(空白填充为9字符)</td></tr><tr><td>DY</td><td>缩写大写日期名(3字符)</td></tr><tr><td>Dy</td><td>缩写混合大小写日期名(3字符)</td></tr><tr><td>dy</td><td>缩写小写日期名(3字符)</td></tr><tr><td>DDD</td><td>一年里的日子(001-366)</td></tr><tr><td>DD</td><td>一个月里的日子(01-31)</td></tr><tr><td>D</td><td>一周里的日子(1-7；周日是1)</td></tr><tr><td>W</td><td>一个月里的周数(1-5)(第一周从该月第一天开始)</td></tr><tr><td>WW</td><td>一年里的周数(1-53)(第一周从该年的第一天开始)</td></tr></tbody></table><h3 id="数值格式化的模板模式"><a href="#数值格式化的模板模式" class="headerlink" title="数值格式化的模板模式"></a>数值格式化的模板模式</h3><table><thead><tr><th>模式</th><th>描述</th></tr></thead><tbody><tr><td>9</td><td>带有指定数值位数的值</td></tr><tr><td>0</td><td>带前导零的值</td></tr><tr><td>.(句点)</td><td>小数点</td></tr><tr><td>,(逗号)</td><td>分组(千)分隔符</td></tr><tr><td>PR</td><td>尖括号内负值</td></tr><tr><td>S</td><td>带符号的数值</td></tr><tr><td>L</td><td>货币符号</td></tr><tr><td>D</td><td>小数点</td></tr><tr><td>G</td><td>分组分隔符</td></tr><tr><td>MI</td><td>在指明的位置的负号(如果数字 &lt; 0)</td></tr><tr><td>PL</td><td>在指明的位置的正号(如果数字 &gt; 0)</td></tr><tr><td>SG</td><td>在指明的位置的正/负号</td></tr></tbody></table><h2 id="时间-日期函数和操作符"><a href="#时间-日期函数和操作符" class="headerlink" title="时间/日期函数和操作符"></a>时间/日期函数和操作符</h2><h3 id="下面是PostgreSQL中支持的时间-日期操作符的列表："><a href="#下面是PostgreSQL中支持的时间-日期操作符的列表：" class="headerlink" title="下面是PostgreSQL中支持的时间/日期操作符的列表："></a>下面是PostgreSQL中支持的时间/日期操作符的列表：</h3><table><thead><tr><th>操作符</th><th>例子</th><th>结果</th></tr></thead><tbody><tr><td>+</td><td>date ‘2001-09-28’ + integer ‘7’</td><td>date ‘2001-10-05’</td></tr><tr><td>+</td><td>date ‘2001-09-28’ + interval ‘1 hour’</td><td>timestamp ‘2001-09-28 01:00’</td></tr><tr><td>+</td><td>date ‘2001-09-28’ + time ‘03:00’</td><td>timestamp ‘2001-09-28 03:00’</td></tr><tr><td>+</td><td>interval ‘1 day’ + interval ‘1 hour’</td><td>interval ‘1 day 01:00’</td></tr><tr><td>+</td><td>timestamp ‘2001-09-28 01:00’ + interval ‘23 hours’</td><td>timestamp ‘2001-09-29 00:00’</td></tr><tr><td>+</td><td>time ‘01:00’ + interval ‘3 hours’</td><td>time ‘04:00’</td></tr><tr><td>-</td><td>- interval ‘23 hours’</td><td>interval ‘-23:00’</td></tr><tr><td>-</td><td>date ‘2001-10-01’ - date ‘2001-09-28’</td><td>integer ‘3’</td></tr><tr><td>-</td><td>date ‘2001-10-01’ - integer ‘7’</td><td>date ‘2001-09-24’</td></tr><tr><td>-</td><td>date ‘2001-09-28’ - interval ‘1 hour’</td><td>timestamp ‘2001-09-27 23:00’</td></tr><tr><td>-</td><td>time ‘05:00’ - time ‘03:00’</td><td>interval ‘02:00’</td></tr><tr><td>-</td><td>time ‘05:00’ - interval ‘2 hours’</td><td>time ‘03:00’</td></tr><tr><td>-</td><td>timestamp ‘2001-09-28 23:00’ - interval ‘23 hours’</td><td>timestamp ‘2001-09-28 00:00’</td></tr><tr><td>-</td><td>interval ‘1 day’ - interval ‘1 hour’</td><td>interval ‘23:00’</td></tr><tr><td>-</td><td>timestamp ‘2001-09-29 03:00’ - timestamp ‘2001-09-27 12:00’</td><td>interval ‘1 day 15:00’</td></tr><tr><td>*</td><td>interval ‘1 hour’ * double precision ‘3.5’</td><td>interval ‘03:30’</td></tr><tr><td>/</td><td>interval ‘1 hour’ / double precision ‘1.5’</td><td>interval ‘00:40’</td></tr></tbody></table><h3 id="日期-时间函数"><a href="#日期-时间函数" class="headerlink" title="日期/时间函数"></a>日期/时间函数</h3><table><thead><tr><th>函数</th><th>返回类型</th><th>描述</th><th>例子</th><th>结果</th></tr></thead><tbody><tr><td>age(timestamp, timestamp)</td><td>interval</td><td>减去参数，生成一个使用年、月的”符号化”的结果</td><td>age(‘2001-04-10’, timestamp ‘1957-06-13’)</td><td>43 years 9 mons 27 days</td></tr><tr><td>age(timestamp)</td><td>interval</td><td>从current_date减去得到的数值</td><td>age(timestamp ‘1957-06-13’)</td><td>43 years 8 mons 3 days</td></tr><tr><td>current_date</td><td>date</td><td>今天的日期</td><td></td><td></td></tr><tr><td>current_time</td><td>time</td><td>现在的时间</td><td></td><td></td></tr><tr><td>current_timestamp</td><td>timestamp</td><td>日期和时间</td><td></td><td></td></tr><tr><td>date_part(text, timestamp)</td><td>double</td><td>获取子域(等效于extract)</td><td>date_part(‘hour’, timestamp ‘2001-02-16 20:38:40’)</td><td>20</td></tr><tr><td>date_part(text, interval)</td><td>double</td><td>获取子域(等效于extract)[可以获取数据表中某个日期字段的部分日期或时间]</td><td>date_part(‘month’, interval ‘2 years 3 months’)</td><td>3</td></tr><tr><td>date_trunc(text, timestamp)</td><td>timestamp</td><td>截断成指定的精度</td><td>date_trunc(‘hour’, timestamp ‘2001-02-16 20:38:40’)</td><td>2001-02-16 20:00:00+00</td></tr><tr><td>extract(field from timestamp)</td><td>double</td><td>获取子域</td><td>extract(hour from timestamp ‘2001-02-16 20:38:40’)</td><td>20</td></tr><tr><td>extract(field from interval)</td><td>double</td><td>获取子域</td><td>extract(month from interval ‘2 years 3 months’)</td><td>3</td></tr><tr><td>localtime</td><td>time</td><td>今日的时间</td><td></td><td></td></tr><tr><td>localtimestamp</td><td>timestamp</td><td>日期和时间</td><td></td><td></td></tr><tr><td>now()</td><td>timestamp</td><td>当前的日期和时间(等效于 current_timestamp)</td><td></td><td></td></tr><tr><td>timeofday()</td><td>text</td><td>当前日期和时间</td><td></td><td></td></tr></tbody></table><h3 id="日期-时间差（EXTRACT-date-part-epoch）"><a href="#日期-时间差（EXTRACT-date-part-epoch）" class="headerlink" title="日期/时间差（EXTRACT/date_part/epoch）"></a>日期/时间差（EXTRACT/date_part/epoch）</h3><table><thead><tr><th>域</th><th>描述</th><th>例子</th><th>结果</th></tr></thead><tbody><tr><td>CENTURY</td><td>世纪</td><td>EXTRACT(CENTURY FROM TIMESTAMP ‘2000-12-16 12:21:13’);</td><td>20</td></tr><tr><td>DAY</td><td>(月分)里的日期域(1-31)</td><td>EXTRACT(DAY from TIMESTAMP ‘2001-02-16 20:38:40’);</td><td>16</td></tr><tr><td>DECADE</td><td>年份域除以10</td><td>EXTRACT(DECADE from TIMESTAMP ‘2001-02-16 20:38:40’);</td><td>200</td></tr><tr><td>DOW</td><td>每周的星期号(0-6；星期天是0) (仅用于timestamp)</td><td>EXTRACT(DOW FROM TIMESTAMP ‘2001-02-16 20:38:40’);</td><td>5</td></tr><tr><td>DOY</td><td>一年的第几天(1 -365/366) (仅用于 timestamp)</td><td>EXTRACT(DOY from TIMESTAMP ‘2001-02-16 20:38:40’);</td><td>47</td></tr><tr><td>HOUR</td><td>小时域(0-23)</td><td>EXTRACT(HOUR from TIMESTAMP ‘2001-02-16 20:38:40’);</td><td>20</td></tr><tr><td>MICROSECONDS</td><td>秒域，包括小数部分，乘以 1,000,000。</td><td>EXTRACT(MICROSECONDS from TIME ‘17:12:28.5’);</td><td>28500000</td></tr><tr><td>MILLENNIUM</td><td>千年</td><td>EXTRACT(MILLENNIUM from TIMESTAMP ‘2001-02-16 20:38:40’);</td><td>3</td></tr><tr><td>MILLISECONDS</td><td>秒域，包括小数部分，乘以 1000。</td><td>EXTRACT(MILLISECONDS from TIME ‘17:12:28.5’);</td><td>28500</td></tr><tr><td>MINUTE</td><td>分钟域(0-59)</td><td>EXTRACT(MINUTE from TIMESTAMP ‘2001-02-16 20:38:40’);</td><td>38</td></tr><tr><td>MONTH</td><td>对于timestamp数值，它是一年里的月份数(1-12)；对于interval数值，它是月的数目，然后对12取模(0-11)</td><td>EXTRACT(MONTH from TIMESTAMP ‘2001-02-16 20:38:40’);</td><td>2</td></tr><tr><td>QUARTER</td><td>该天所在的该年的季度(1-4)(仅用于 timestamp)</td><td>EXTRACT(QUARTER from TIMESTAMP ‘2001-02-16 20:38:40’);</td><td>1</td></tr><tr><td>SECOND</td><td>秒域，包括小数部分(0-59[1])</td><td>EXTRACT(SECOND from TIMESTAMP ‘2001-02-16 20:38:40’);</td><td>40</td></tr><tr><td>WEEK</td><td>该天在所在的年份里是第几周。</td><td>EXTRACT(WEEK from TIMESTAMP ‘2001-02-16 20:38:40’);</td><td>7</td></tr><tr><td>YEAR</td><td>年份域</td><td>EXTRACT(YEAR from TIMESTAMP ‘2001-02-16 20:38:40’);</td><td>2001</td></tr></tbody></table><h4 id="相对时间差–取自域"><a href="#相对时间差–取自域" class="headerlink" title="相对时间差–取自域"></a>相对时间差–取自域</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">EXTRACT</span>(EPOCH <span class="keyword">FROM</span> (<span class="built_in">TIMESTAMP</span> <span class="string">'2022-02-18 16:50:23'</span>- <span class="built_in">TIMESTAMP</span> <span class="string">'2022-02-18 16:49:23'</span>));                 <span class="comment">--60</span></span><br><span class="line"><span class="keyword">SELECT</span> date_part(<span class="string">'MINUTE'</span>,<span class="keyword">cast</span>(<span class="string">'2022-02-18 16:50:23'</span> <span class="keyword">as</span> <span class="built_in">TIMESTAMP</span>)-<span class="keyword">cast</span>(<span class="string">'2022-02-18 16:49:23'</span> <span class="keyword">as</span> <span class="built_in">TIMESTAMP</span>));    <span class="comment">--1 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 日期之差（绝对）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">round</span>(date_part(<span class="string">'epoch'</span>, <span class="built_in">TIMESTAMP</span>​​​​​​​​​​​​​​ <span class="string">'2020-05-05 11:11:20'</span> - <span class="built_in">TIMESTAMP</span> <span class="string">'2020-05-05 10:10:10'</span>));   <span class="comment">--获取秒差 3670=3600+60+10</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">round</span>(date_part(<span class="string">'epoch'</span>, <span class="built_in">TIMESTAMP</span> <span class="string">'2020-05-05 11:11:20'</span> - <span class="built_in">TIMESTAMP</span> <span class="string">'2020-05-05 10:10:10'</span>)/<span class="number">60</span>);   <span class="comment">--获取分钟差 61=60+1</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">round</span>(date_part(<span class="string">'epoch'</span>, <span class="built_in">TIMESTAMP</span> <span class="string">'2020-05-05 12:11:20'</span> - <span class="built_in">TIMESTAMP</span> <span class="string">'2020-05-05 10:10:10'</span>)/<span class="number">60</span>/<span class="number">60</span>);    <span class="comment">--获取小时差 2</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="built_in">Date</span>(<span class="string">'2022-04-02'</span>) - <span class="built_in">Date</span>(<span class="string">'2022-02-01'</span>);    <span class="comment">--获取天数差 60=31+28+1</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> age(<span class="built_in">TIMESTAMP</span> <span class="string">'2022-04-05'</span>,<span class="built_in">TIMESTAMP</span> <span class="string">'2021-02-04'</span>)) * <span class="number">12</span>  + <span class="keyword">extract</span>(<span class="keyword">MONTH</span> <span class="keyword">from</span> age(<span class="built_in">TIMESTAMP</span> <span class="string">'2022-04-05'</span>,<span class="built_in">TIMESTAMP</span> <span class="string">'2021-02-04'</span>));    <span class="comment">--获取月份差 14=12+2</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> age(<span class="built_in">TIMESTAMP</span> <span class="string">'2022-07-08'</span>,<span class="built_in">TIMESTAMP</span> <span class="string">'2014-07-07'</span>));   <span class="comment">--获取年份差  8</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> age(<span class="built_in">TIMESTAMP</span> <span class="string">'2022-07-07'</span>,<span class="built_in">TIMESTAMP</span> <span class="string">'2014-07-07'</span>));   <span class="comment">--获取年份差  8</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">extract</span>(<span class="keyword">year</span> <span class="keyword">from</span> age(<span class="built_in">TIMESTAMP</span> <span class="string">'2022-07-06'</span>,<span class="built_in">TIMESTAMP</span> <span class="string">'2014-07-07'</span>));   <span class="comment">--获取年份差  7</span></span><br></pre></td></tr></table></figure><h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p><a href="https://blog.csdn.net/lixinkuan328/article/details/107969398" target="_blank" rel="external nofollow noopener noreferrer">原文链接</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Postgresql中string转换成timestamp类型&quot;&gt;&lt;a href=&quot;#Postgresql中string转换成timestamp类型&quot; class=&quot;headerlink&quot; title=&quot;Postgresql中string转换成timestamp类
      
    
    </summary>
    
    
    
      <category term="postgresql" scheme="https://blog.wjc66.cn/tags/postgresql/"/>
    
  </entry>
  
  <entry>
    <title>postgresql-raise函数</title>
    <link href="https://blog.wjc66.cn/postgresql-raise%E5%87%BD%E6%95%B0/"/>
    <id>https://blog.wjc66.cn/postgresql-raise%E5%87%BD%E6%95%B0/</id>
    <published>2022-09-08T06:32:44.000Z</published>
    <updated>2022-09-08T07:16:14.192Z</updated>
    
    <content type="html"><![CDATA[<p>raise函数<br>在PostgreSQL中，该函数用于打印字符串，类似于Java中的System.out.println()，Oracle中的dbms_output.put_line()。</p><p>用法如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">raise notice 'My name is %, I am a %.', 'Lewis', 'coder';</span><br></pre></td></tr></table></figure><p>以上sql会在控制台输出My name is Lewis, I am a coder.。如果是在DBeaver里使用该函数，则会在output的tab里输出字符串。</p><p>raise后面的notice是级别，一共有debug/log/info/notice/warning/exception这些级别，可以任意指定一个级别。有些类似于Java里的日志框架，比如Log4j2之类的。</p><p>接着级别后面的是要输出的字符串参数，用一对单引号包括起来。这个字符串支持占位符的写法，也就是%这个字符。如果在字符串里使用了这个%，那么会自动使用字符串参数后面的参数来替换掉这里的%。有多少个占位符，就需要在第一个字符串参数后面加上多少个对应的参数。</p><p>这个占位符输出的用法，也和Log4j2类似。</p><p>由raise打印出来的信息可以输出到服务端日志，也可以输出到客户端，亦或者同时输出到二者。这个是由log_min_messages和client_min_messages两个参数控制的，这两个参数在数据库初始化时用到。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;raise函数&lt;br&gt;在PostgreSQL中，该函数用于打印字符串，类似于Java中的System.out.println()，Oracle中的dbms_output.put_line()。&lt;/p&gt;
&lt;p&gt;用法如下：&lt;/p&gt;
&lt;figure class=&quot;highligh
      
    
    </summary>
    
    
    
      <category term="postgresql" scheme="https://blog.wjc66.cn/tags/postgresql/"/>
    
  </entry>
  
  <entry>
    <title>POSTGRESQL存储过程（PROCEDURES）和函数（FUNCTIONS）</title>
    <link href="https://blog.wjc66.cn/POSTGRESQL%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%EF%BC%88PROCEDURES%EF%BC%89%E5%92%8C%E5%87%BD%E6%95%B0%EF%BC%88FUNCTIONS%EF%BC%89/"/>
    <id>https://blog.wjc66.cn/POSTGRESQL%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%EF%BC%88PROCEDURES%EF%BC%89%E5%92%8C%E5%87%BD%E6%95%B0%EF%BC%88FUNCTIONS%EF%BC%89/</id>
    <published>2022-09-08T06:13:05.000Z</published>
    <updated>2022-09-09T04:12:17.530Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>在pg中存储过程和函数创建方式一样，写法都差不多<br>区别：<br>存储过程（Procedures）：无返回值（返回值为void）的函数（function）。<br>函数（functions）：有返回值（返回值非void）的函数（function）。</p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="格式"><a href="#格式" class="headerlink" title="格式"></a>格式</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">function</span> <span class="keyword">if</span> <span class="keyword">exists</span> [函数名];</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> [函数名] ([参数]) <span class="keyword">returns</span> [返回值] <span class="keyword">as</span></span><br><span class="line"> $$</span><br><span class="line"><span class="keyword">declare</span> </span><br><span class="line">  [变量声明]</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  [<span class="keyword">sql</span>逻辑]</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line">$$</span><br><span class="line">language 'plpgsql';</span><br></pre></td></tr></table></figure><p>推荐使用Navicat来创建，如图：<br><img src="https://img-blog.csdnimg.cn/9ccc5b96a00f4630a807bd6b4f5e0e5e.png" alt="在这里插入图片描述"></p><h3 id="函数使用"><a href="#函数使用" class="headerlink" title="函数使用"></a>函数使用</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">FUNCTION</span> <span class="string">"public"</span>.<span class="string">"update_us_businessoperationperiod"</span>()</span><br><span class="line">  <span class="keyword">RETURNS</span> <span class="string">"pg_catalog"</span>.<span class="string">"void"</span> <span class="keyword">AS</span> $<span class="keyword">BODY</span>$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line"><span class="comment">-- 定义变量</span></span><br><span class="line">business_detail <span class="built_in">record</span>;</span><br><span class="line">current_date_n timestamp;</span><br><span class="line">current_date_s VARCHAR;</span><br><span class="line">num int :=0;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">   <span class="comment">-- 循环需要处理的数据</span></span><br><span class="line">   <span class="keyword">FOR</span> business_detail <span class="keyword">IN</span> (<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">"cddKycBusinessDetail"</span> <span class="keyword">WHERE</span> <span class="string">"kycId"</span> = <span class="string">'7145720d-e57b-4b4e-8b97-a97662520f35'</span>) <span class="keyword">LOOP</span></span><br><span class="line"> <span class="comment">-- 获取注册时间转时间戳</span></span><br><span class="line"> current_date_n := TO_TIMESTAMP(business_detail.<span class="string">"businessRegistrationDate"</span>, <span class="string">'YYYY-MM-DD'</span>);</span><br><span class="line"> <span class="comment">-- 注册时间加一年</span></span><br><span class="line"> current_date_n := current_date_n + '1 year';</span><br><span class="line"> <span class="comment">-- 时间戳转字符串</span></span><br><span class="line"> current_date_s := to_char(current_date_n, 'YYYY-MM-DD');</span><br><span class="line"> </span><br><span class="line"> num := num + 1;</span><br><span class="line"> <span class="comment">-- 更改有效时间</span></span><br><span class="line"> <span class="keyword">UPDATE</span> <span class="string">"cddKycBusinessDetail"</span> <span class="keyword">SET</span> <span class="string">"businessOperationPeriod"</span> = current_date_s <span class="keyword">WHERE</span> <span class="string">"id"</span> = business_detail.<span class="string">"id"</span>;</span><br><span class="line"> <span class="comment">-- 打印</span></span><br><span class="line"> raise notice 'cddKycBusinessDetail id:%, %, %, %.',business_detail."id", business_detail."businessRegistrationDate", current_date_s, num;</span><br><span class="line">     <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line">RETURN;</span><br><span class="line">  <span class="keyword">END</span></span><br><span class="line">$<span class="keyword">BODY</span>$</span><br><span class="line">  <span class="keyword">LANGUAGE</span> plpgsql VOLATILE</span><br><span class="line">  <span class="keyword">COST</span> <span class="number">100</span></span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> <span class="string">"public"</span>.<span class="string">"update_rate"</span>(account_ids <span class="built_in">text</span>[])</span><br><span class="line"><span class="keyword">RETURNS</span> <span class="built_in">void</span> <span class="keyword">AS</span> $<span class="keyword">BODY</span>$</span><br><span class="line"><span class="keyword">DECLARE</span></span><br><span class="line">account_id <span class="built_in">text</span>;</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">-- Routine body goes here...</span></span><br><span class="line">   FOREACH account_id <span class="keyword">IN</span> <span class="built_in">ARRAY</span> account_ids                             </span><br><span class="line">    <span class="keyword">LOOP</span>                                                    </span><br><span class="line">        <span class="keyword">raise</span> <span class="keyword">notice</span> <span class="string">'accountId:%'</span>, account_id;</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">LOOP</span>;   </span><br><span class="line">RETURN;</span><br><span class="line"><span class="keyword">END</span>$<span class="keyword">BODY</span>$</span><br><span class="line"><span class="keyword">LANGUAGE</span> plpgsql</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 执行</span></span><br><span class="line"><span class="keyword">SELECT</span> update_rate(<span class="built_in">ARRAY</span>[<span class="string">'fc3827ec-58e9-4f42-a661-a3aa658c3e61'</span>])</span><br></pre></td></tr></table></figure><h3 id="存储过程使用"><a href="#存储过程使用" class="headerlink" title="存储过程使用"></a>存储过程使用</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">PROCEDURE</span> <span class="string">"public"</span>.<span class="string">"update_us_businessoperationperiod_2"</span>()</span><br><span class="line"> <span class="keyword">AS</span> $<span class="keyword">BODY</span>$</span><br><span class="line"> <span class="keyword">DECLARE</span></span><br><span class="line"><span class="comment">-- 定义变量</span></span><br><span class="line">business_detail <span class="built_in">record</span>;</span><br><span class="line">current_date_n timestamp;</span><br><span class="line">current_date_s VARCHAR;</span><br><span class="line">num int :=0;</span><br><span class="line"> <span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">-- 循环需要处理的数据</span></span><br><span class="line">   <span class="keyword">FOR</span> business_detail <span class="keyword">IN</span> (<span class="keyword">SELECT</span> * <span class="keyword">from</span> <span class="string">"cddKycBusinessDetail"</span> <span class="keyword">where</span> <span class="string">"kycId"</span> <span class="keyword">in</span> (<span class="keyword">SELECT</span> <span class="string">"id"</span> <span class="keyword">from</span> <span class="string">"cddKyc"</span> <span class="keyword">where</span> <span class="string">"isLatest"</span> = <span class="literal">true</span> <span class="keyword">and</span> <span class="keyword">status</span> != <span class="string">'Pending'</span>) <span class="keyword">and</span> <span class="string">"registrationRegion"</span> = <span class="string">'US'</span> <span class="keyword">and</span> <span class="string">"businessOperationPeriod"</span> = <span class="string">''</span>) <span class="keyword">LOOP</span></span><br><span class="line"> <span class="keyword">IF</span> business_detail.<span class="string">"businessRegistrationDate"</span> ~ <span class="string">'.000z'</span> <span class="keyword">then</span></span><br><span class="line">    <span class="comment">-- 获取注册时间转时间戳 2022-05-30T16:00:00.000Z</span></span><br><span class="line">    current_date_n := TO_TIMESTAMP(business_detail.<span class="string">"businessRegistrationDate"</span>, <span class="string">'YYYY-MM-DDTHH24:MI:SS.000z'</span>);</span><br><span class="line"> ELSE</span><br><span class="line">    <span class="comment">-- 获取注册时间转时间戳 2022-05-30</span></span><br><span class="line">    current_date_n := TO_TIMESTAMP(business_detail."businessRegistrationDate", 'YYYY-MM-DD');</span><br><span class="line"> <span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"> <span class="comment">-- 注册时间加一年</span></span><br><span class="line"> current_date_n := current_date_n + '1 year';</span><br><span class="line"> <span class="comment">-- 时间戳转字符串</span></span><br><span class="line"> current_date_s := to_char(current_date_n, 'YYYY-MM-DD');</span><br><span class="line"> </span><br><span class="line"> num := num + 1;</span><br><span class="line"> <span class="comment">-- 更改有效时间</span></span><br><span class="line"> <span class="keyword">UPDATE</span> <span class="string">"cddKycBusinessDetail"</span> <span class="keyword">SET</span> <span class="string">"businessOperationPeriod"</span> = current_date_s <span class="keyword">WHERE</span> <span class="string">"id"</span> = business_detail.<span class="string">"id"</span>;</span><br><span class="line"> <span class="comment">-- 打印</span></span><br><span class="line"> raise notice 'cddKycBusinessDetail id:%, %, %, %.',business_detail."id", business_detail."businessRegistrationDate", current_date_s, num;</span><br><span class="line">     <span class="keyword">END</span> <span class="keyword">LOOP</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span>$<span class="keyword">BODY</span>$</span><br><span class="line">  <span class="keyword">LANGUAGE</span> plpgsql</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">PROCEDURE</span> <span class="string">"public"</span>.<span class="string">"update_rate"</span>()</span><br><span class="line"> <span class="keyword">AS</span> $<span class="keyword">BODY</span>$</span><br><span class="line"> <span class="keyword">DECLARE</span></span><br><span class="line">account_ids <span class="built_in">text</span>[];</span><br><span class="line">account_id text;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">-- 直接从表中查数据进行循环</span></span><br><span class="line">account_ids := <span class="built_in">ARRAY</span>(<span class="keyword">SELECT</span> <span class="string">"id"</span> <span class="keyword">from</span> <span class="keyword">account</span>)::<span class="built_in">text</span>[];</span><br><span class="line"></span><br><span class="line">FOREACH account_id IN ARRAY account_ids                             </span><br><span class="line">    LOOP                                                    </span><br><span class="line">        raise notice 'accountId:%', account_id;</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">LOOP</span>;   </span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span>$<span class="keyword">BODY</span>$</span><br><span class="line">  <span class="keyword">LANGUAGE</span> plpgsql</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">PROCEDURE</span> <span class="string">"public"</span>.<span class="string">"update_rate"</span>()</span><br><span class="line"> <span class="keyword">AS</span> $<span class="keyword">BODY</span>$</span><br><span class="line"> <span class="keyword">DECLARE</span></span><br><span class="line">account_ids <span class="built_in">text</span>[];</span><br><span class="line">account_id text;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">BEGIN</span></span><br><span class="line"><span class="comment">-- Routine body goes here...</span></span><br><span class="line">account_ids := <span class="built_in">ARRAY</span>[<span class="string">'fc3827ec-58e9-4f42-a661-a3aa658c3e61'</span>];</span><br><span class="line"></span><br><span class="line">FOREACH account_id IN ARRAY account_ids                             </span><br><span class="line">    LOOP                                                    </span><br><span class="line">        raise notice 'accountId:%', account_id;</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">LOOP</span>;   </span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span>$<span class="keyword">BODY</span>$</span><br><span class="line">  <span class="keyword">LANGUAGE</span> plpgsql</span><br></pre></td></tr></table></figure><h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p><a href="http://www.postgres.cn/docs/10/xplang.html" target="_blank" rel="external nofollow noopener noreferrer">postgresql 官方文档</a><br><a href="https://www.wjc66.cn/postgresql-raise函数/" target="_blank" rel="external nofollow noopener noreferrer">postgresql  raise函数</a><br><a href="https://www.wjc66.cn/postgresql日期相关函数/" target="_blank" rel="external nofollow noopener noreferrer">postgresql日期相关函数</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;p&gt;在pg中存储过程和函数创建方式一样，写法都差不多&lt;br&gt;区别：&lt;br&gt;存储过程（Procedures）：无返回值（返回值为void）的函数（
      
    
    </summary>
    
    
    
      <category term="postgresql" scheme="https://blog.wjc66.cn/tags/postgresql/"/>
    
  </entry>
  
  <entry>
    <title>TypeScript装饰器</title>
    <link href="https://blog.wjc66.cn/TypeScript%E8%A3%85%E9%A5%B0%E5%99%A8/"/>
    <id>https://blog.wjc66.cn/TypeScript%E8%A3%85%E9%A5%B0%E5%99%A8/</id>
    <published>2022-04-08T08:00:13.000Z</published>
    <updated>2022-04-08T08:08:22.259Z</updated>
    
    <content type="html"><![CDATA[<h2 id="TypeScript-装饰器（decorators）"><a href="#TypeScript-装饰器（decorators）" class="headerlink" title="TypeScript 装饰器（decorators）"></a>TypeScript 装饰器（decorators）</h2><h4 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h4><p>随着 TypeScript 和 ES6 里引入了类，在一些场景下我们需要额外的特性来支持标注或修改类及其成员。 装饰器（Decorators）为我们在类的声明及成员上通过元编程语法添加标注提供了一种方式</p><p>若要启用实验性的装饰器特性，你必须在命令行或 tsconfig.json 里启用 experimentalDecorators 编译器选项</p><p>装饰器是一种特殊类型的声明，它能够被附加到类声明，方法， 访问符，属性或参数上。它可以在不修改代码自身的前提下，给已有代码增加额外的行为</p><a id="more"></a><h4 id="如何定义装饰器"><a href="#如何定义装饰器" class="headerlink" title="如何定义装饰器"></a>如何定义装饰器</h4><p>装饰器本身其实就是一个函数，理论上忽略参数的话，任何函数都可以当做装饰器使用。例：<br><img src="https://img-blog.csdnimg.cn/b395d828580548309bb20db21cadb236.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/01e5db190c6045b58ef392621507d510.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/6f0f4a6744684de18576ad682185b018.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>这个注解也称 <code>JavaScript中函数柯里化特性</code></p><p><img src="https://img-blog.csdnimg.cn/a84781a59e6d4c7686eebb4a0d300c8f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><h4 id="装饰器执行时机"><a href="#装饰器执行时机" class="headerlink" title="装饰器执行时机"></a>装饰器执行时机</h4><p>修饰器对类的行为的改变，是代码编译时发生的（不是 TypeScript 编译，而是 js 在执行机中编译阶段），而不是在运行时。这意味着，修饰器能在编译阶段运行代码。也就是说，修饰器本质就是编译时执行的函数。<br>在 Node.js 环境中模块一加载时就会执行</p><h3 id="五种装饰器"><a href="#五种装饰器" class="headerlink" title="五种装饰器"></a>五种装饰器</h3><p>类装饰器、属性装饰器、方法装饰器、访问器装饰器、参数装饰器；</p><h4 id="类装饰器"><a href="#类装饰器" class="headerlink" title="类装饰器"></a>类装饰器</h4><p>应用于类构造函数，其参数是类的构造函数。<br>注意 class 并不是像 Java 那种强类型语言中的类，而是 JavaScript 构造函数的语法糖。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 类装饰器</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@returns</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> Class2Decorator = (options?: any): <span class="function"><span class="params">ClassDecorator</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">target: object</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"我是类装饰器，我跑起来了"</span>);</span><br><span class="line">    <span class="built_in">Reflect</span>.defineMetadata(<span class="string">"SCOPE_OPTIONS_METADATA"</span>, options, target);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/1de912e5b3d8492b974e4bcf3249bfe2.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><h4 id="属性装饰器"><a href="#属性装饰器" class="headerlink" title="属性装饰器"></a>属性装饰器</h4><p>属性装饰器表达式会在运行时当作函数被调用，传入下列 2 个参数：</p><p>1、对于静态成员来说是类的构造函数，对于实例成员是类的原型对象。<br>2、成员的名字。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 属性装饰器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> PropertyDecorator = <span class="function">(<span class="params">value: string</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">target: object, key: string | symbol</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"我是属性装饰器，我跑起来了"</span>, key);</span><br><span class="line">    target[key] = value;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/ac99883d853a401badf8d24d44181880.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><h4 id="方法装饰器"><a href="#方法装饰器" class="headerlink" title="方法装饰器"></a>方法装饰器</h4><p>它会被应用到方法的 属性描述符上，可以用来监视，修改或者替换方法定义。<br>方法装饰会在运行时传入下列 3 个参数：</p><p>1、对于静态成员来说是类的构造函数，对于实例成员是类的原型对象。<br>2、成员的名字。<br>3、成员的属性描述符。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 方法装饰器</span><br><span class="line"> */</span><br><span class="line"><span class="built_in">export</span> const MethodDecorator = (options?: any): MethodDecorator =&gt; &#123;</span><br><span class="line">  <span class="built_in">return</span> (target: any, key?: any, descriptor?: PropertyDescriptor) =&gt; &#123;</span><br><span class="line">    console.log(<span class="string">'我是方法装饰器，我跑起来了'</span>, key);</span><br><span class="line">    Reflect.defineMetadata(`MethodDecorator`, options, target?.constructor);</span><br><span class="line"></span><br><span class="line">    const oldFunc = descriptor.value;</span><br><span class="line">    descriptor.value = async (...args: any) =&gt; &#123;</span><br><span class="line">      <span class="built_in">let</span> result: any;</span><br><span class="line">      try &#123;</span><br><span class="line">        console.log(<span class="string">'拿到方法的参数==============&gt;'</span>, args);</span><br><span class="line">        result = await oldFunc.apply(this, args);</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        throw e;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">return</span> result;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">return</span> descriptor;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/37e21ec40bcb4358918b26b704737476.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><h4 id="访问器装饰器"><a href="#访问器装饰器" class="headerlink" title="访问器装饰器"></a>访问器装饰器</h4><p>在 js 中类中（Object）中的属性有 4 个描述起行为的特性：<br>Configurable:表示能否通过 delete 删除属性从而重新定义属性；<br>Enumerable：表示能否通过 for-in 循环返回属性<br>writable：表示能否修改属性的值<br>Value：包含这个属性的数据值（个人认为其作用就是赋值）<br>以上四个属性在不显示调用 Object.defineProperty()的时候，前三个默认值都为 true，而 value 为你自己设定的值，如果不设定的话则为 undefined。<br>而其中最特殊的则是 configurable，根据《javascript 高级程序设计（第三版）》所说：一旦把该属性定义为 false 之后，那么除了 writable 之外，其他所有的属性都无法再修改。</p><blockquote><p>注意 TypeScript 不允许同时装饰一个成员的 get 和 set 访问器。取而代之的是，一个成员的所有装饰的必须应用在文档顺序的第一个访问器上。这是因为，在装饰器应用于一个属性描述符时，它联合了 get 和 set 访问器，而不是分开声明的。</p></blockquote><blockquote><p>对比结果：方法装饰器的 descriptor 有 value 和 witable 属性，但没有 get 和 set 属性；访问器装饰器有 get 和 set 属性，但没有 value 和 witable 属性。</p></blockquote><ol><li>访问器注解<br><img src="https://img-blog.csdnimg.cn/487c127d7afa40d085ca6575dbcafd7a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></li><li>普通方法注解<br><img src="https://img-blog.csdnimg.cn/35b8b857e03a4ee1b8e11a0acb3f78c8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></li></ol><h4 id="参数装饰器"><a href="#参数装饰器" class="headerlink" title="参数装饰器"></a>参数装饰器</h4><p>参数装饰器表达式会在运行时当作函数被调用，传入下列 3 个参数：</p><p>1、对于静态成员来说是类的构造函数，对于实例成员是类的原型对象。<br>2、参数的名字。<br>3、参数在函数参数列表中的索引。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 参数装饰器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> ParamsDecorator = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">target: any, key: string | symbol, index: number</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"我是参数装饰器，我跑起来了"</span>, key, index);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/290db925645a445aaec74e8fe76aefa2.png" alt="在这里插入图片描述"></p><h2 id="装饰器加载顺序"><a href="#装饰器加载顺序" class="headerlink" title="装饰器加载顺序"></a>装饰器加载顺序</h2><p><img src="https://img-blog.csdnimg.cn/38c5cdabf4254bdabe445363d3940e3f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>从上述例子得出如下结论：</p><p>1、有多个参数装饰器时：从最后一个参数依次向前执行</p><p>2、方法和方法参数中参数装饰器先执行。</p><p>3、类装饰器总是最后执行。</p><p>4、方法和属性装饰器，谁在前面谁先执行。因为参数属于方法一部分，所以参数会一直紧紧挨着方法执行。</p><p>5、方法参数装饰器&gt;方法装饰器&gt;类装饰器，自右向左，自内而外，自上而下。</p><h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p><a href="https://es6.ruanyifeng.com/#docs/decorator" target="_blank" rel="external nofollow noopener noreferrer">装饰器</a><br><a href="https://www.cnblogs.com/winfred/p/8216650.html" target="_blank" rel="external nofollow noopener noreferrer">陈峰装饰器</a></p><h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p><a href="https://github.com/klover2/typeScript-decorator" target="_blank" rel="external nofollow noopener noreferrer">gitHub</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;TypeScript-装饰器（decorators）&quot;&gt;&lt;a href=&quot;#TypeScript-装饰器（decorators）&quot; class=&quot;headerlink&quot; title=&quot;TypeScript 装饰器（decorators）&quot;&gt;&lt;/a&gt;TypeScript 装饰器（decorators）&lt;/h2&gt;&lt;h4 id=&quot;描述&quot;&gt;&lt;a href=&quot;#描述&quot; class=&quot;headerlink&quot; title=&quot;描述&quot;&gt;&lt;/a&gt;描述&lt;/h4&gt;&lt;p&gt;随着 TypeScript 和 ES6 里引入了类，在一些场景下我们需要额外的特性来支持标注或修改类及其成员。 装饰器（Decorators）为我们在类的声明及成员上通过元编程语法添加标注提供了一种方式&lt;/p&gt;
&lt;p&gt;若要启用实验性的装饰器特性，你必须在命令行或 tsconfig.json 里启用 experimentalDecorators 编译器选项&lt;/p&gt;
&lt;p&gt;装饰器是一种特殊类型的声明，它能够被附加到类声明，方法， 访问符，属性或参数上。它可以在不修改代码自身的前提下，给已有代码增加额外的行为&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="nodejs" scheme="https://blog.wjc66.cn/tags/nodejs/"/>
    
      <category term="typescript" scheme="https://blog.wjc66.cn/tags/typescript/"/>
    
  </entry>
  
  <entry>
    <title>通过注解获取对应的类型</title>
    <link href="https://blog.wjc66.cn/%E9%80%9A%E8%BF%87%E6%B3%A8%E8%A7%A3%E8%8E%B7%E5%8F%96%E5%AF%B9%E5%BA%94%E7%9A%84%E7%B1%BB%E5%9E%8B/"/>
    <id>https://blog.wjc66.cn/%E9%80%9A%E8%BF%87%E6%B3%A8%E8%A7%A3%E8%8E%B7%E5%8F%96%E5%AF%B9%E5%BA%94%E7%9A%84%E7%B1%BB%E5%9E%8B/</id>
    <published>2022-03-30T07:12:49.000Z</published>
    <updated>2022-03-30T07:24:20.487Z</updated>
    
    <content type="html"><![CDATA[<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> klover</span></span><br><span class="line"><span class="comment"> * 处理器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.TYPE&#125;)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Processor &#123;</span><br><span class="line">    <span class="meta">@AliasFor</span>(</span><br><span class="line">            annotation = Component<span class="class">.<span class="keyword">class</span></span></span><br><span class="line"><span class="class">    )</span></span><br><span class="line">    String value() default "";</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Target</span>(&#123;ElementType.METHOD&#125;)</span><br><span class="line">    <span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line">    <span class="meta">@interface</span> Process &#123;</span><br><span class="line">        <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><a id="more"></a><ol><li>通过 SpringContextUtil 获取</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.qbit.common.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.jetbrains.annotations.NotNull;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.BeansException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Annotation;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringContextUtil</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(@NotNull ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        context = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前环境</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> env</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getActiveProfile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> context.getEnvironment().getActiveProfiles()[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isProd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"prod"</span>.equals(getActiveProfile());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取applicationContext</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ApplicationContext</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationContext <span class="title">getApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> context;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过Annotation获取 Bean.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz 注解类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Map&lt;String, Object&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, Object&gt; <span class="title">getBeansWithAnnotation</span><span class="params">(Class&lt;? extends Annotation&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> context.getBeansWithAnnotation(clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取注解的类名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz 注解类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String[]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String[] getBeanNamesForAnnotation(Class&lt;? extends Annotation&gt; clazz)&#123;</span><br><span class="line">        <span class="keyword">return</span> context.getBeanNamesForAnnotation(clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过name获取 Bean.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name 名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getBean</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> context.getBean(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过class获取Bean.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz 类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 类</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> &lt;T&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getBean</span><span class="params">(Class&lt;T&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> context.getBean(clazz);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String, Object&gt; beans = SpringContextUtil.getBeansWithAnnotation(Processor<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">for</span> (String key : beans.keySet()) &#123;</span><br><span class="line">            Object oldBean = beans.get(key);</span><br><span class="line">            Object bean = oldBean;</span><br><span class="line">            <span class="comment">// 开启aop后getAnnotation拿不到原生类 所以需要这个</span></span><br><span class="line">            <span class="keyword">while</span> (AopUtils.isAopProxy(bean)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    bean = ((Advised) bean).getTargetSource().getTarget();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"get target bean failed"</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">assert</span> bean != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            Class&lt;?&gt; clazz = bean.getClass();</span><br><span class="line">            System.out.println(clazz.getName());</span><br><span class="line"></span><br><span class="line">            Processor annotation = clazz.getAnnotation(Processor<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            System.out.println(annotation);</span><br><span class="line">            Method[] methods = clazz.getDeclaredMethods();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">                <span class="keyword">if</span> (method.isAnnotationPresent(Processor.Process<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">                    System.out.println(method);</span><br><span class="line">                    Method method1 = oldBean.getClass().getMethod(method.getName());</span><br><span class="line">                    method1.invoke(oldBean);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>通过 Reflections 获取</li></ol><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https:<span class="comment">//mvnrepository.com/artifact/org.reflections/reflections --&gt;</span></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.reflections&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;reflections&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.10.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Reflections f = <span class="keyword">new</span> Reflections(packageName);</span><br><span class="line">        Set&lt;Class&lt;?&gt;&gt; set = f.getTypesAnnotatedWith(Processor<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; c : set) &#123;</span><br><span class="line">            Object bean = c.getDeclaredConstructor().newInstance();</span><br><span class="line">            Processor annotation = c.getAnnotation(Processor<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            Method[] methods = bean.getClass().getDeclaredMethods();</span><br><span class="line">            <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">                <span class="keyword">if</span> (method.isAnnotationPresent(Processor.Process<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">                    System.out.println(method);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            beanContainer.put(annotation.value(), bean);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt; * &lt;span class=&quot;doctag&quot;&gt;@author&lt;/span&gt; klover&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt; * 处理器&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt; */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Target&lt;/span&gt;(&amp;#123;ElementType.TYPE&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Retention&lt;/span&gt;(RetentionPolicy.RUNTIME)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Documented&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Component&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Inherited&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;meta&quot;&gt;@interface&lt;/span&gt; Processor &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@AliasFor&lt;/span&gt;(&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            annotation = Component&lt;span class=&quot;class&quot;&gt;.&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;    )&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    String value() default &quot;&quot;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     * 执行器&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Target&lt;/span&gt;(&amp;#123;ElementType.METHOD&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Retention&lt;/span&gt;(RetentionPolicy.RUNTIME)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@interface&lt;/span&gt; Process &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;function&quot;&gt;String &lt;span class=&quot;title&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt; &quot;&quot;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
    
      <category term="java" scheme="https://blog.wjc66.cn/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>飞书-企业自建应用</title>
    <link href="https://blog.wjc66.cn/%E9%A3%9E%E4%B9%A6-%E4%BC%81%E4%B8%9A%E8%87%AA%E5%BB%BA%E5%BA%94%E7%94%A8/"/>
    <id>https://blog.wjc66.cn/%E9%A3%9E%E4%B9%A6-%E4%BC%81%E4%B8%9A%E8%87%AA%E5%BB%BA%E5%BA%94%E7%94%A8/</id>
    <published>2022-02-21T08:44:36.000Z</published>
    <updated>2022-02-21T08:55:32.388Z</updated>
    
    <content type="html"><![CDATA[<h1 id="企业自建应用-嵌入三方网页"><a href="#企业自建应用-嵌入三方网页" class="headerlink" title="企业自建应用 嵌入三方网页"></a>企业自建应用 嵌入三方网页</h1><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ol><li><p>进入<code>https://open.feishu.cn/app?lang=zh-CN</code></p></li><li><p>选择创建自建应用-内容随便</p></li><li><p>获取对应的应用凭证<br><img src="https://img-blog.csdnimg.cn/12c92114f8584f10b3a2c2aca6f41ba3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p></li><li><p>嵌入网页配置<br><img src="https://img-blog.csdnimg.cn/7d733f9fd91a4266ba8ec41391962940.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>手机端和电脑端可以一样</p></li><li><p>在权限关联中授权获取手机号和邮箱<br><img src="https://img-blog.csdnimg.cn/af64c572686147a5a271d6b4298156af.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p></li></ol><h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><ol><li>获取 AppAccessToken<br>文档： <code>https://open.feishu.cn/document/ukTMukTMukTM/ukDNz4SO0MjL5QzM/auth-v3/auth/app_access_token_internal</code></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">const res = await request</span><br><span class="line">      .post(<span class="string">'https://open.feishu.cn/open-apis/auth/v3/app_access_token/internal'</span>)</span><br><span class="line">      .<span class="built_in">set</span>(&#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/json; charset=utf-8'</span>,</span><br><span class="line">      &#125;)</span><br><span class="line">      .send(&#123;</span><br><span class="line">        app_id: data.client_id,</span><br><span class="line">        app_secret: data.client_secret,</span><br><span class="line">      &#125;);</span><br><span class="line">    const body = res.body;</span><br><span class="line">    <span class="keyword">if</span> (!(body.msg === <span class="string">'ok'</span> &amp;&amp; body.code === 0)) throw new CustomException(-1, <span class="string">'获取app_access_token失败'</span>);</span><br><span class="line">    const &#123; app_access_token, expire &#125; = body;</span><br></pre></td></tr></table></figure><ol start="2"><li>获取用户信息<br>文档<code>https://open.feishu.cn/document/uAjLw4CM/ukTMukTMukTM/reference/authen-v1/authen/access_token</code></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">const res = await request</span><br><span class="line">      .post(<span class="string">'https://open.feishu.cn/open-apis/authen/v1/access_token'</span>)</span><br><span class="line">      .<span class="built_in">set</span>(&#123;</span><br><span class="line">        <span class="string">'Content-Type'</span>: <span class="string">'application/json; charset=utf-8'</span>,</span><br><span class="line">        Authorization: `Bearer <span class="variable">$&#123;data.access_token&#125;</span>`,</span><br><span class="line">      &#125;)</span><br><span class="line">      .send(&#123;</span><br><span class="line">        grant_type: <span class="string">'authorization_code'</span>,</span><br><span class="line">        code: code,</span><br><span class="line">      &#125;);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;企业自建应用-嵌入三方网页&quot;&gt;&lt;a href=&quot;#企业自建应用-嵌入三方网页&quot; class=&quot;headerlink&quot; title=&quot;企业自建应用 嵌入三方网页&quot;&gt;&lt;/a&gt;企业自建应用 嵌入三方网页&lt;/h1&gt;&lt;h2 id=&quot;配置&quot;&gt;&lt;a href=&quot;#配置&quot; cla
      
    
    </summary>
    
    
    
      <category term="飞书" scheme="https://blog.wjc66.cn/tags/%E9%A3%9E%E4%B9%A6/"/>
    
  </entry>
  
  <entry>
    <title>amazon配置邮件推送服务</title>
    <link href="https://blog.wjc66.cn/amazon%E9%85%8D%E7%BD%AE%E9%82%AE%E4%BB%B6%E6%8E%A8%E9%80%81%E6%9C%8D%E5%8A%A1/"/>
    <id>https://blog.wjc66.cn/amazon%E9%85%8D%E7%BD%AE%E9%82%AE%E4%BB%B6%E6%8E%A8%E9%80%81%E6%9C%8D%E5%8A%A1/</id>
    <published>2022-02-21T08:44:36.000Z</published>
    <updated>2022-03-30T07:01:57.065Z</updated>
    
    <content type="html"><![CDATA[<h2 id="亚马逊邮箱推送配置"><a href="#亚马逊邮箱推送配置" class="headerlink" title="亚马逊邮箱推送配置"></a>亚马逊邮箱推送配置</h2><ol><li><p>进入<code>Amazon Simple Email Service</code>服务<br><img src="https://img-blog.csdnimg.cn/8e02bde958154d65916d263e32f38e09.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p></li><li><p>在 Account dashboard-&gt;Simple Mail Transfer Protocol (SMTP) settings-&gt;create SMTP credentials 创建简单邮件传输协议 (SMTP) - （如果不想设置就用最高账户）<br><img src="https://img-blog.csdnimg.cn/1bc1b69874884f94845ecd07e81b4971.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>记好对应的 smtp user 和 smtp password<br>忘了也没事 可以在<a href="https://console.aws.amazon.com/iamv2/home?#/home" target="_blank" rel="external nofollow noopener noreferrer">IAM 控制面板</a><br><img src="https://img-blog.csdnimg.cn/7591d5ef6a1244fcaa8e686fea95efdc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p></li><li><p>修改对应权限 把 ses 的权限都选中<br><img src="https://img-blog.csdnimg.cn/4777b3b316ac4f2da511f1dbe8046c6b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p></li><li><p>配置域名<br><img src="https://img-blog.csdnimg.cn/59e2e067a59142fa9f2d718e15287bb0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/3fac5f066fb642f38e958d93992b76d3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/7f747537abd447028d4e5d1ed8a5f995.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p></li><li><p>配置管理集 （例如取名-noreply）<br><img src="https://img-blog.csdnimg.cn/bcc61d0f76254d3ea315daed06c79c1d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="6."></p></li><li><p>获取 Amazon SES SMTP 凭证<br>文档<code>https://docs.aws.amazon.com/zh_cn/ses/latest/dg/smtp-credentials.html</code></p></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> crypto <span class="keyword">from</span> <span class="string">"crypto"</span>;</span><br><span class="line"><span class="comment">// The values of the following variables should always stay the same.</span></span><br><span class="line"><span class="keyword">const</span> date = <span class="string">"11111111"</span>;</span><br><span class="line"><span class="keyword">const</span> service = <span class="string">"ses"</span>;</span><br><span class="line"><span class="keyword">const</span> terminal = <span class="string">"aws4_request"</span>;</span><br><span class="line"><span class="keyword">const</span> message = <span class="string">"SendRawEmail"</span>;</span><br><span class="line"><span class="keyword">const</span> version = <span class="string">"04"</span>;</span><br><span class="line"><span class="keyword">const</span> region = <span class="string">"us-west-1"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Modify this variable to include your AWS secret access key</span></span><br><span class="line"><span class="keyword">const</span> key = <span class="string">"wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> kDate = HmacSha256(date, Buffer.from(<span class="string">"AWS4"</span> + key, <span class="string">"utf8"</span>));</span><br><span class="line"><span class="keyword">const</span> kRegion = HmacSha256(region, kDate);</span><br><span class="line"><span class="keyword">const</span> kService = HmacSha256(service, kRegion);</span><br><span class="line"><span class="keyword">const</span> kTerminal = HmacSha256(terminal, kService);</span><br><span class="line"><span class="keyword">const</span> kMessage = HmacSha256(message, kTerminal);</span><br><span class="line"><span class="keyword">const</span> signatureAndVersion = Buffer.concat([</span><br><span class="line">  Buffer.from(version, <span class="string">"hex"</span>),</span><br><span class="line">  kMessage,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取smtpPassword 以后就可以永久使用了 除非更新了 AWS secret access key</span></span><br><span class="line"><span class="keyword">const</span> smtpPassword = signatureAndVersion.toString(<span class="string">"base64"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HmacSha256</span>(<span class="params">data: string, key: Buffer</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> crypto.createHmac(<span class="string">"sha256"</span>, key).update(data).digest();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>发送邮件-使用 smtp 发送</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> nodemailer <span class="keyword">from</span> <span class="string">"nodemailer"</span>;</span><br><span class="line"><span class="keyword">const</span> mailer = nodemailer.createTransport(&#123;</span><br><span class="line">  host: <span class="string">"email-smtp.us-west-1.amazonaws.com"</span>,</span><br><span class="line">  port: <span class="string">"465"</span>,</span><br><span class="line">  ignoreTLS: <span class="literal">true</span>,</span><br><span class="line">  secure: <span class="literal">true</span>,</span><br><span class="line">  auth: &#123;</span><br><span class="line">    user: <span class="string">"AWS 访问密钥 ID"</span>,</span><br><span class="line">    pass: smtpPassword,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>发送邮件-使用 npm 包 发送</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mailerService = <span class="keyword">new</span> SES(&#123;</span><br><span class="line">  region: <span class="string">"us-west-1"</span>,</span><br><span class="line">  credentialDefaultProvider: <span class="function">(<span class="params">input: any</span>) =&gt;</span> <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">    <span class="built_in">Promise</span>.resolve(&#123;</span><br><span class="line">      accessKeyId: <span class="string">"AWS 访问密钥 ID"</span>,</span><br><span class="line">      secretAccessKey: <span class="string">"wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"</span>, <span class="comment">// secret access key</span></span><br><span class="line">    &#125;),</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">/** 收件人邮箱 */</span></span><br><span class="line"><span class="keyword">const</span> destination = &#123;</span><br><span class="line">  <span class="comment">/** 收件 */</span></span><br><span class="line">  ToAddresses: [<span class="string">"test@qq.com"</span>],</span><br><span class="line">  <span class="comment">/** 抄送 */</span></span><br><span class="line">  <span class="comment">// CcAddresses: [],</span></span><br><span class="line">  <span class="comment">/** 密件抄送 */</span></span><br><span class="line">  <span class="comment">// BccAddresses:[]</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/** 标题 */</span></span><br><span class="line"><span class="keyword">const</span> subject = &#123;</span><br><span class="line">  Data: <span class="string">"test"</span>,</span><br><span class="line">  Charset: <span class="keyword">this</span>.mailInfo.charset,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/** 内容 */</span></span><br><span class="line"><span class="keyword">const</span> body = &#123;</span><br><span class="line">  Html: &#123;</span><br><span class="line">    Data: <span class="string">"&lt;P&gt;test&lt;/P&gt;"</span>,</span><br><span class="line">    Charset: <span class="string">"UTF-8"</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.mailerService.sendEmail(&#123;</span><br><span class="line">  Message: &#123; <span class="attr">Subject</span>: subject, <span class="attr">Body</span>: body &#125;,</span><br><span class="line">  Source: <span class="keyword">from</span>,</span><br><span class="line">  Destination: destination,</span><br><span class="line">  ConfigurationSetName: <span class="string">"noreply"</span>, <span class="comment">// 上面配置的管理集</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ol start="7"><li>移出 Amazon SES 沙盒<br>文档<code>https://docs.aws.amazon.com/zh_cn/ses/latest/dg/request-production-access.html</code></li></ol><p><img src="https://img-blog.csdnimg.cn/c390e5d98281496ca0145023d1752295.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/e654d17f7efc409380d7a1e7d073e018.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><p><code>注意</code>: 里面内容不用乱写，最好详细介绍你为啥要使用这个，不然容易驳回</p><h2 id="出现的问题"><a href="#出现的问题" class="headerlink" title="出现的问题"></a>出现的问题</h2><ol><li>没有移除邮箱不能随便发送到其他邮箱，可以自己添加对应的邮箱到 amazon ses 中，他会发一封验证邮件 验证通过就可以测试邮件发送了<br><img src="https://img-blog.csdnimg.cn/c9461fa734bf48d9bf94fd8b8e68ecb8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></li><li>关于发送邮件日志的查询<br>还在处理中 文档 <a href="https://aws.amazon.com/cn/premiumsupport/knowledge-center/ses-email-sending-history/" target="_blank" rel="external nofollow noopener noreferrer"> Amazon Simple Email Service（Amazon SES）中查看电子邮件发送历史记录。该如何操作?</a></li></ol><h2 id="邮件接收回调"><a href="#邮件接收回调" class="headerlink" title="邮件接收回调"></a>邮件接收回调</h2><p>由于流记录那种方式没有配置成功，所以还是配置回调来记录接收情况。<br>文档： <a href="https://docs.aws.amazon.com/zh_cn/ses/latest/dg/configure-sns-notifications.html" target="_blank" rel="external nofollow noopener noreferrer">使用 Amazon SES 控制台来配置通知</a></p><ol><li>创建主题 <code>https://us-west-1.console.aws.amazon.com/sns/v3/home?region=us-west-1#/topics</code><br><img src="https://img-blog.csdnimg.cn/77654bdba94541378f4f9ce9e6a35e29.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></li><li>为主题增加订阅<br><img src="https://img-blog.csdnimg.cn/d736fb6c2cc9433d9c8a4b6e79745054.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>选择 https 协议，如果选择邮箱太烦了，这样就会推送到你的服务器上<br><img src="https://img-blog.csdnimg.cn/367594b02ffe4abfa5dfdb6fd6f95fbc.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></li><li>服务器接收 - 它是 text/plain 方式请求过来的 拿出里面的<code>SubscribeURL</code></li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result: string = <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> data = <span class="string">""</span>;</span><br><span class="line">  req.setEncoding(<span class="string">"utf8"</span>);</span><br><span class="line">  req.on(<span class="string">"data"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">chunk</span>) </span>&#123;</span><br><span class="line">    data += chunk;</span><br><span class="line">  &#125;);</span><br><span class="line">  req.on(<span class="string">"end"</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    resolve(data);</span><br><span class="line">  &#125;);</span><br><span class="line">  req.on(<span class="string">"error"</span>, (err) =&gt; reject(err));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者直接 req.body</span></span><br></pre></td></tr></table></figure><ol start="4"><li>使用<code>SubscribeURL</code> 来确认订阅 正常就可以了<br><img src="https://img-blog.csdnimg.cn/f6b6bd56f4c2481fa98768cc20fae886.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></li><li>接入到对应的发送邮件域名中</li></ol><p><img src="https://img-blog.csdnimg.cn/423fce423dfb44d8ab8d4fd40e3c4c99.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>主题选择你自己设置的名称就可以了</p><h2 id="文档"><a href="#文档" class="headerlink" title="文档"></a>文档</h2><p><a href="https://docs.aws.amazon.com/zh_cn/opensearch-service/latest/developerguide/integrations.html" target="_blank" rel="external nofollow noopener noreferrer">Amazon Kinesis Data Firehose 加载流数据</a><br><a href="https://docs.aws.amazon.com/zh_cn/ses/latest/dg/event-publishing-add-event-destination-firehose.html#event-publishing-add-event-destination-firehose-role" target="_blank" rel="external nofollow noopener noreferrer">为 Amazon SES 事件发布设置 Kinesis Data Firehose 事件目的地</a><br><a href="https://us-west-1.console.aws.amazon.com/firehose/home?region=us-west-1#/streams" target="_blank" rel="external nofollow noopener noreferrer">流控制台</a><br><a href="https://docs.aws.amazon.com/ses/latest/dg/monitor-sending-activity.html" target="_blank" rel="external nofollow noopener noreferrer">监控您的 Amazon SES 发送活动</a><br><a href="https://docs.aws.amazon.com/ses/latest/dg/configure-sns-notifications.html" target="_blank" rel="external nofollow noopener noreferrer">为 Amazon SES 配置 Amazon SNS 通知</a><br><a href="https://aws.amazon.com/cn/premiumsupport/knowledge-center/ses-email-sending-history/" target="_blank" rel="external nofollow noopener noreferrer"> Amazon Simple Email Service（Amazon SES）中查看电子邮件发送历史记录。该如何操作?</a><br><a href="https://docs.aws.amazon.com/zh_cn/ses/latest/dg/request-production-access.html" target="_blank" rel="external nofollow noopener noreferrer">关于移除沙盒</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;亚马逊邮箱推送配置&quot;&gt;&lt;a href=&quot;#亚马逊邮箱推送配置&quot; class=&quot;headerlink&quot; title=&quot;亚马逊邮箱推送配置&quot;&gt;&lt;/a&gt;亚马逊邮箱推送配置&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;进入&lt;code&gt;Amazon Simple Email Servi
      
    
    </summary>
    
    
    
      <category term="amazon" scheme="https://blog.wjc66.cn/tags/amazon/"/>
    
  </entry>
  
  <entry>
    <title>如何对typescript进行单元测试</title>
    <link href="https://blog.wjc66.cn/%E5%A6%82%E4%BD%95%E5%AF%B9typescript%E8%BF%9B%E8%A1%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/"/>
    <id>https://blog.wjc66.cn/%E5%A6%82%E4%BD%95%E5%AF%B9typescript%E8%BF%9B%E8%A1%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/</id>
    <published>2022-01-06T13:34:18.000Z</published>
    <updated>2022-03-30T07:06:54.333Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><code>yarn add -D ts-jest jest @types/jest</code></p><h3 id="全局安装"><a href="#全局安装" class="headerlink" title="全局安装"></a>全局安装</h3><p><code>npm i jest -g</code></p><h2 id="初始化-jest"><a href="#初始化-jest" class="headerlink" title="初始化 jest"></a>初始化 jest</h2><p><code>jest --init</code></p><h2 id="移除生成的-jest-config-js-文件"><a href="#移除生成的-jest-config-js-文件" class="headerlink" title="移除生成的 jest.config.js 文件"></a>移除生成的 jest.config.js 文件</h2><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>在 package.json 中配置</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"jest"</span>: &#123;</span><br><span class="line">    <span class="string">"moduleFileExtensions"</span>: [</span><br><span class="line">      <span class="string">"js"</span>,</span><br><span class="line">      <span class="string">"json"</span>,</span><br><span class="line">      <span class="string">"ts"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"rootDir"</span>: <span class="string">"."</span>,</span><br><span class="line">    <span class="string">"testRegex"</span>: <span class="string">".spec.ts$"</span>,</span><br><span class="line">    <span class="string">"transform"</span>: &#123;</span><br><span class="line">      <span class="string">"^.+\\.(t|j)s$"</span>: <span class="string">"ts-jest"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"coverageDirectory"</span>: <span class="string">"./coverage"</span>,</span><br><span class="line">    <span class="string">"testEnvironment"</span>: <span class="string">"node"</span>,</span><br><span class="line">    <span class="string">"roots"</span>: [</span><br><span class="line">      <span class="string">"&lt;rootDir&gt;/test/"</span></span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">"test"</span>, () =&gt; &#123;</span><br><span class="line">  beforeAll(<span class="keyword">async</span> () =&gt; &#123;&#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">"test"</span>, () =&gt; &#123;&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;安装&quot;&gt;&lt;a href=&quot;#安装&quot; class=&quot;headerlink&quot; title=&quot;安装&quot;&gt;&lt;/a&gt;安装&lt;/h2&gt;&lt;p&gt;&lt;code&gt;yarn add -D ts-jest jest @types/jest&lt;/code&gt;&lt;/p&gt;
&lt;h3 id=&quot;全局安装&quot;&gt;&lt;a
      
    
    </summary>
    
    
    
      <category term="typescript" scheme="https://blog.wjc66.cn/tags/typescript/"/>
    
  </entry>
  
  <entry>
    <title>PostgreSQL中JSONB的使用</title>
    <link href="https://blog.wjc66.cn/PostgreSQL%E4%B8%ADJSONB%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>https://blog.wjc66.cn/PostgreSQL%E4%B8%ADJSONB%E7%9A%84%E4%BD%BF%E7%94%A8/</id>
    <published>2021-12-27T05:23:52.000Z</published>
    <updated>2021-12-27T05:58:23.733Z</updated>
    
    <content type="html"><![CDATA[<h2 id="json-类型"><a href="#json-类型" class="headerlink" title="json 类型"></a>json 类型</h2><h3 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h3><p>根据 RFC 7159[1]中的说明，JSON 数据类型是用来存储 JSON（JavaScript Object Notation） 数据的。这种数据也可以被存储为 text，但是 JSON 数据类型的 优势在于能强制要求每个被存储的值符合 JSON 规则。也有很多 JSON 相关的函 数和操作符可以用于存储在这些数据类型中的数据</p><p>PostgreSQL 支持两种 JSON 数据类型：json 和 jsonb。它们几乎接受完全相同的值集合作为输入。两者最大的区别是效率。json 数据类型存储输入文本的精准拷贝，处理函数必须在每 次执行时必须重新解析该数据。而 jsonb 数据被存储在一种分解好的二进制格式中，因为需要做附加的转换，它在输入时要稍慢一些。但是 jsonb 在处理时要快很多，因为不需要重新解析。</p><blockquote><p>重点：jsonb 支持索引</p></blockquote><a id="more"></a><p>由于 json 类型存储的是输入文本的准确拷贝，存储时会空格和 JSON 对象内部的键的顺序。如果一个值中的 JSON 对象包含同一个键超过一次，所有的键/值对都会被保留（** 处理函数会把最后的值当作有效值**）。</p><p>jsonb 不保留空格、不保留对象键的顺序并且不保留重复的对象键。如果在输入中指定了重复的键，只有最后一个值会被保留。</p><blockquote><p>推荐把 JSON 数据存储为 jsonb</p></blockquote><p>在把文本 JSON 输入转换成 jsonb 时，JSON 的基本类型（RFC 7159[1] ）会被映射到原生的 PostgreSQL 类型。因此，jsonb 数据有一些次要额外约束。比如：jsonb 将拒绝除 PostgreSQL numeric 数据类型范围之外的数字，而 json 则不会。</p><h2 id="json-输入输出语法"><a href="#json-输入输出语法" class="headerlink" title="json 输入输出语法"></a>json 输入输出语法</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">-- 简单标量/基本值</span><br><span class="line">-- 基本值可以是数字、带引号的字符串、<span class="literal">true</span>、<span class="literal">false</span>或者null</span><br><span class="line">SELECT <span class="string">'5'</span>::json;</span><br><span class="line"></span><br><span class="line">-- 有零个或者更多元素的数组（元素不需要为同一类型）</span><br><span class="line">SELECT <span class="string">'[1, 2, "foo", null]'</span>::json;</span><br><span class="line"></span><br><span class="line">-- 包含键值对的对象</span><br><span class="line">-- 注意对象键必须总是带引号的字符串</span><br><span class="line">SELECT <span class="string">'&#123;"bar": "baz", "balance": 7.77, "active": false&#125;'</span>::json;</span><br><span class="line"></span><br><span class="line">-- 数组和对象可以被任意嵌套</span><br><span class="line">SELECT <span class="string">'&#123;"foo": [true, "bar"], "tags": &#123;"a": 1, "b": null&#125;&#125;'</span>::json;</span><br><span class="line"></span><br><span class="line">-- <span class="string">"-&gt;"</span> 通过键获得 JSON 对象域 结果为json对象</span><br><span class="line">select <span class="string">'&#123;"nickname": "goodspeed", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::json-&gt;<span class="string">'nickname'</span> as nickname;</span><br><span class="line"> nickname</span><br><span class="line">-------------</span><br><span class="line"> <span class="string">"goodspeed"</span></span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">-- <span class="string">"-&gt;&gt;"</span> 通过键获得 JSON 对象域 结果为text</span><br><span class="line">select <span class="string">'&#123;"nickname": "goodspeed", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::json-&gt;&gt;<span class="string">'nickname'</span> as nickname;</span><br><span class="line"> nickname</span><br><span class="line">-----------</span><br><span class="line"> goodspeed</span><br><span class="line"></span><br><span class="line">-- <span class="string">"-&gt;"</span> 通过键获得 JSON 对象域 结果为json对象</span><br><span class="line">select <span class="string">'&#123;"nickname": "goodspeed", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::jsonb-&gt;<span class="string">'nickname'</span> as nickname;</span><br><span class="line"> nickname</span><br><span class="line">-------------</span><br><span class="line"> <span class="string">"goodspeed"</span></span><br><span class="line">(1 row)</span><br><span class="line"></span><br><span class="line">-- <span class="string">"-&gt;&gt;"</span> 通过键获得 JSON 对象域 结果为text</span><br><span class="line">select <span class="string">'&#123;"nickname": "goodspeed", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::jsonb-&gt;&gt;<span class="string">'nickname'</span> as nickname;</span><br><span class="line"> nickname</span><br><span class="line">-----------</span><br><span class="line"> goodspeed</span><br><span class="line">(1 row)</span><br></pre></td></tr></table></figure><h2 id="包含和存在"><a href="#包含和存在" class="headerlink" title="包含和存在"></a>包含和存在</h2><h3 id="gt-和-gt-gt-操作符"><a href="#gt-和-gt-gt-操作符" class="headerlink" title="-&gt; 和 -&gt;&gt; 操作符"></a>-&gt; 和 -&gt;&gt; 操作符</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-- nickname 为 gs 的用户 这里使用 -&gt;&gt; 查出的数据为text，所以匹配项也应该是text</span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::json-&gt;&gt;<span class="string">'nickname'</span> = <span class="string">'gs'</span>;</span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::jsonb-&gt;&gt;<span class="string">'nickname'</span> = <span class="string">'gs'</span>;</span><br><span class="line"></span><br><span class="line">-- 使用 -&gt; 查询，会抛出错误，这里无论匹配项是text类型的 <span class="string">'gs'</span>  还是 json 类型的 <span class="string">'"gs"'</span>::json都会抛出异常，json 类型不支持 等号（=）操作符</span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::json-&gt;<span class="string">'nickname'</span> = <span class="string">'"gs"'</span>;</span><br><span class="line">ERROR:  operator does not exist: json = unknown</span><br><span class="line"></span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::json-&gt;<span class="string">'nickname'</span> = <span class="string">'"gs"'</span>::json;</span><br><span class="line">ERROR:  operator does not exist: json = json</span><br><span class="line"></span><br><span class="line">-- jsonb 格式是可以查询成功的，这里使用 -&gt; 查出的数据为json 对象，所以匹配项也应该是json 对象</span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::jsonb-&gt;<span class="string">'nickname'</span> = <span class="string">'"gs"'</span>;</span><br></pre></td></tr></table></figure><blockquote><p>使用 -&gt;&gt; 查出的数据为 text 使用 -&gt; 查出的数据为 json 对象</p></blockquote><h3 id="gt-和-gt-gt-操作符-1"><a href="#gt-和-gt-gt-操作符-1" class="headerlink" title="#&gt; 和 #&gt;&gt; 操作符"></a>#&gt; 和 #&gt;&gt; 操作符</h3><blockquote><p>使用 #&gt;&gt; 查出的数据为 text 使用 #&gt; 查出的数据为 json 对象</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::json<span class="comment">#&gt;'&#123;tags,0&#125;' as tag;</span></span><br><span class="line">   tag</span><br><span class="line">----------</span><br><span class="line"> <span class="string">"python"</span></span><br><span class="line"></span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::json<span class="comment">#&gt;&gt;'&#123;tags,0&#125;' as tag;</span></span><br><span class="line">  tag</span><br><span class="line">--------</span><br><span class="line"> python</span><br><span class="line"></span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::jsonb<span class="comment">#&gt;'&#123;tags,0&#125;' = '"python"';</span></span><br><span class="line"> ?column?</span><br><span class="line">----------</span><br><span class="line"> t</span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::jsonb<span class="comment">#&gt;&gt;'&#123;tags,0&#125;' = 'python';</span></span><br><span class="line"> ?column?</span><br><span class="line">----------</span><br><span class="line"> t</span><br><span class="line"></span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::json<span class="comment">#&gt;&gt;'&#123;tags,0&#125;' = 'python';</span></span><br><span class="line"> ?column?</span><br><span class="line">----------</span><br><span class="line"> t</span><br><span class="line">-- 会抛出错误，这里无论匹配项是text类型的 <span class="string">'python'</span>  还是 json 类型的 <span class="string">'"python"'</span>::json都会抛出异常，json 类型不支持 等号（=）操作符</span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::json<span class="comment">#&gt;'&#123;tags,0&#125;' = '"python"';</span></span><br><span class="line">ERROR:  operator does not exist: json = unknown</span><br></pre></td></tr></table></figure><h2 id="jsonb-数据查询（不适用于-json）"><a href="#jsonb-数据查询（不适用于-json）" class="headerlink" title="jsonb 数据查询（不适用于 json）"></a>jsonb 数据查询（不适用于 json）</h2><h3 id="gt-操作符"><a href="#gt-操作符" class="headerlink" title="@&gt;操作符"></a>@&gt;操作符</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-- nickname 为 nickname 的用户</span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::jsonb @&gt; <span class="string">'&#123;"nickname": "gs"&#125;'</span>::jsonb;</span><br><span class="line"></span><br><span class="line">-- 等同于以下查询</span><br><span class="line">-- 这里使用 -&gt; 查出的数据为json 对象，所以匹配项也应该是json 对象</span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::jsonb-&gt;<span class="string">'nickname'</span> = <span class="string">'"gs"'</span>;</span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::jsonb-&gt;&gt;<span class="string">'nickname'</span> = <span class="string">'gs'</span>;</span><br><span class="line"></span><br><span class="line">-- 查询有 python 和 golang 标签的数据</span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::jsonb @&gt; <span class="string">'&#123;"tags": ["python", "golang"]&#125;'</span>;</span><br><span class="line"> ?column?</span><br><span class="line">----------</span><br><span class="line"> t</span><br></pre></td></tr></table></figure><h3 id="操作符、-操作符和-amp-操作符"><a href="#操作符、-操作符和-amp-操作符" class="headerlink" title="?操作符、?|操作符和?&amp;操作符"></a>?操作符、?|操作符和?&amp;操作符</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-- 查询有 avatar 属性的用户</span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::jsonb ? <span class="string">'avatar'</span>;</span><br><span class="line">-- 查询有 avatar 属性 并且avatar 数据不为空的数据</span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "avatar": null, "tags": ["python", "golang", "db"]&#125;'</span>::jsonb-&gt;&gt;<span class="string">'avatar'</span> is not <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">-- 查询 有 avatar 或 tags 的数据</span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "tags": ["python", "golang", "db"]&#125;'</span>::jsonb ?| array[<span class="string">'avatar'</span>, <span class="string">'tags'</span>];</span><br><span class="line"> ?column?</span><br><span class="line">----------</span><br><span class="line"> t</span><br><span class="line"></span><br><span class="line">-- 查询 既有 avatar 又有 tags 的用户</span><br><span class="line">select <span class="string">'&#123;"nickname": "gs", "tags": ["python", "golang", "db"]&#125;'</span>::jsonb ?&amp; array[<span class="string">'avatar'</span>, <span class="string">'tags'</span>];</span><br><span class="line"> ?column?</span><br><span class="line">----------</span><br><span class="line"> f</span><br><span class="line"></span><br><span class="line"> -- 查询 tags 中包含 python 标签的数据</span><br><span class="line"> select <span class="string">'&#123;"nickname": "gs", "avatar": "avatar_url", "tags": ["python", "golang", "db"]&#125;'</span>::jsonb-&gt;<span class="string">'tags'</span> ? <span class="string">'python'</span>;</span><br><span class="line"> ?column?</span><br><span class="line">----------</span><br><span class="line"> t</span><br></pre></td></tr></table></figure><h2 id="json-和-jsonb-的操作符列表"><a href="#json-和-jsonb-的操作符列表" class="headerlink" title="json 和 jsonb 的操作符列表"></a>json 和 jsonb 的操作符列表</h2><h3 id="json-和-jsonb-操作符"><a href="#json-和-jsonb-操作符" class="headerlink" title="json 和 jsonb 操作符"></a>json 和 jsonb 操作符</h3><p><img src="https://img-blog.csdnimg.cn/9ccc01b6ffff49899299fe404358df1d.png" alt="在这里插入图片描述"></p><h3 id="额外的-jsonb-操作符"><a href="#额外的-jsonb-操作符" class="headerlink" title="额外的 jsonb 操作符"></a>额外的 jsonb 操作符</h3><p><img src="https://img-blog.csdnimg.cn/327e12ce9d3c4cbfa06fe4ed4f5cfd22.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><h2 id="新增或者修改"><a href="#新增或者修改" class="headerlink" title="新增或者修改"></a>新增或者修改</h2><p><code>原始数据结构 {&quot;accountClear&quot;: {&quot;clearType&quot;: &quot;Clear&quot;, &quot;csmReason&quot;: &quot;钱不对&quot;, &quot;addToBlackList&quot;: {&quot;blackCorporate&quot;: true, &quot;blackEnterprise&quot;: true}, &quot;applyReviewReason&quot;: &quot;钱不对&quot;}}</code></p><ol><li><p>修改 clearType 的参数<br><code>update apply set &quot;data&quot; = jsonb_set(&quot;data&quot;::jsonb, &#39;{accountClear, clearType}&#39;, &#39;&quot;Clear&quot;&#39;, true) where &quot;type&quot; = &#39;AccountClear&#39;;</code></p></li><li><p>移除 accountClear<br><code>update apply set &quot;data&quot;= &quot;data&quot;- &#39;accountClear&#39; where id=&#39;4cb0568d-d571-4256-8aea-7eee9a6dca1c&#39;;</code></p></li><li><p>移除 data 中 accountClear 下的 clearType<br><code>update apply set &quot;data&quot;= &quot;data&quot; #- &#39;{accountClear,clearType}&#39; where id=&#39;4cb0568d-d571-4256-8aea-7eee9a6dca1c&#39;;</code></p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">jsonb_set(target         jsonb,  // 需要修改的数据</span><br><span class="line">          path           text[], // 数据路径</span><br><span class="line">          new_value      jsonb,  // 新数据</span><br><span class="line">          create_missing boolean default <span class="literal">true</span>)</span><br></pre></td></tr></table></figure><p><code>如果 create_missing 是 true （缺省是 true），并且 path 指定的路径在 target 中不存在，那么 target 将包含 path 指定部分， new_value 替换部分， 或者 new_value 添加部分。</code></p><h2 id="GIN-索引介绍"><a href="#GIN-索引介绍" class="headerlink" title="GIN 索引介绍"></a>GIN 索引介绍</h2><p>JSONB 最常用的是 GIN 索引，GIN 索引可以被用来有效地搜索在大量 jsonb 文档（数据）中出现 的键或者键值对。</p><blockquote><p>GIN(Generalized Inverted Index, 通用倒排索引) 是一个存储对(key, posting list)集合的索引结构，其中 key 是一个键值，而 posting list 是一组出现过 key 的位置。如(‘hello’, ‘14:2 23:4’)中，表示 hello 在 14:2 和 23:4 这两个位置出现过，在 PG 中这些位置实际上就是元组的 tid(行号，包括数据块 ID（32bit）,以及 item point(16 bit) )。</p></blockquote><blockquote><p>在表中的每一个属性，在建立索引时，都可能会被解析为多个键值，所以同一个元组的 tid 可能会出现在多个 key 的 posting list 中。</p></blockquote><blockquote><p>通过这种索引结构可以快速的查找到包含指定关键字的元组，因此 GIN 索引特别适用于多值类型的元素搜索，比如支持全文搜索，数组中元素的搜索，而 PG 的 GIN 索引模块最初也是为了支持全文搜索而开发的。</p></blockquote><p>jsonb 的默认 GIN 操作符类支持使用顶层键存在运算符?、?&amp;以及?| 操作符和路径/值存在运算符@&gt;的查询。</p><p><code>-- 创建默认索引</code><br><code>CREATE INDEX idxgin ON api USING GIN (jdoc);</code></p><p>非默认的 GIN 操作符类 jsonb_path_ops 只支持索引@&gt;操作符。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- 创建指定路径的索引</span><br><span class="line">CREATE INDEX idxgin ON api USING GIN (jdoc, (<span class="string">'a'</span>-&gt;<span class="string">'b'</span>));</span><br></pre></td></tr></table></figure><p>eg:</p><p><code>EXPLAIN SELECT * from apply where &quot;data&quot;-&gt;&#39;accountClear&#39;-&gt;&#39;clearType&#39; ? &#39;LogOff&#39;</code></p><p>上述 sql 会使用索引：<br><img src="https://img-blog.csdnimg.cn/5de8c6b5ade14fc296250282dc1010ae.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><p><code>EXPLAIN SELECT * from apply where &quot;data&quot;-&gt;&#39;accountClear&#39;-&gt;&#39;clearType&#39; = &#39;&quot;LogOff&quot;&#39;</code></p><p><img src="https://img-blog.csdnimg.cn/441e7bffd7d6471d994b01e2fd03d298.png" alt="在这里插入图片描述"></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;json-类型&quot;&gt;&lt;a href=&quot;#json-类型&quot; class=&quot;headerlink&quot; title=&quot;json 类型&quot;&gt;&lt;/a&gt;json 类型&lt;/h2&gt;&lt;h3 id=&quot;说明&quot;&gt;&lt;a href=&quot;#说明&quot; class=&quot;headerlink&quot; title=&quot;说明&quot;&gt;&lt;/a&gt;说明&lt;/h3&gt;&lt;p&gt;根据 RFC 7159[1]中的说明，JSON 数据类型是用来存储 JSON（JavaScript Object Notation） 数据的。这种数据也可以被存储为 text，但是 JSON 数据类型的 优势在于能强制要求每个被存储的值符合 JSON 规则。也有很多 JSON 相关的函 数和操作符可以用于存储在这些数据类型中的数据&lt;/p&gt;
&lt;p&gt;PostgreSQL 支持两种 JSON 数据类型：json 和 jsonb。它们几乎接受完全相同的值集合作为输入。两者最大的区别是效率。json 数据类型存储输入文本的精准拷贝，处理函数必须在每 次执行时必须重新解析该数据。而 jsonb 数据被存储在一种分解好的二进制格式中，因为需要做附加的转换，它在输入时要稍慢一些。但是 jsonb 在处理时要快很多，因为不需要重新解析。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;重点：jsonb 支持索引&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
    
      <category term="postgresql" scheme="https://blog.wjc66.cn/tags/postgresql/"/>
    
  </entry>
  
  <entry>
    <title>压测工具使用</title>
    <link href="https://blog.wjc66.cn/%E5%8E%8B%E6%B5%8B%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/"/>
    <id>https://blog.wjc66.cn/%E5%8E%8B%E6%B5%8B%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8/</id>
    <published>2021-12-16T09:34:43.000Z</published>
    <updated>2021-12-16T10:19:57.883Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Apache-Bench"><a href="#Apache-Bench" class="headerlink" title="Apache Bench"></a>Apache Bench</h2><p>Apache Bench 简介<br>ApacheBench 是 Apache 服务器自带的一个 web 压力测试工具，简称 ab。ab 又是一个命令行工具，对发起负载的本机要求很低，根据 ab 命令可以创建很多的并发访问线程，模拟多个访问者同时对某一 URL 地址进行访问，因此可以用来测试目标服务器的负载压力。总的来说 ab 工具小巧简单，上手学习较快，可以提供需要的基本性能指标，但是没有图形化结果，不能监控。</p><a id="more"></a><ol><li><p><a href="https://www.apachelounge.com/download/#google_vignette" target="_blank" rel="external nofollow noopener noreferrer">下载</a></p><p><img src="https://img-blog.csdnimg.cn/cb7d20bc7f9040c38d4a0fadd05dbdbf.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p></li><li><p>解压到本地就可以直接使用,使用如下<br><code>.\bin\abs.exe -c 1 -n 1 -p .\body.txt -T application/json http://127.0.0.1:3000/testing/nium/api/v1/authorization</code></p></li></ol><p><img src="https://img-blog.csdnimg.cn/9ca0540115c0436cad7042e636115b3d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>body.txt 就是请求的 body 参数<br><img src="https://img-blog.csdnimg.cn/d3a1a92dc12644238c80507c808b6b15.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p><ol start="3"><li>参数介绍：</li></ol><p>参数说明：<br>格式：ab [options] [http://]hostname[:port]/path</p><p>-n requests Number of requests to perform //本次测试发起的总请求数<br>-c concurrency Number of multiple requests to make //一次产生的请求数（或并发数）<br>-t timelimit Seconds to max. wait for responses //测试所进行的最大秒数，默认没有时间限制。<br>-r Don’t exit on socket receive errors. // 抛出异常继续执行测试任务<br>-p postfile File containing data to POST //包含了需要 POST 的数据的文件，文件格式如“p1=1&amp;p2=2”.使用方法是 -p 111.txt</p><p>-T content-type Content-type header for POSTing<br>//POST 数据所使用的 Content-type 头信息，如 -T “application/x-www-form-urlencoded” 。 （配合-p）</p><p>-v verbosity How much troubleshooting info to print<br>//设置显示信息的详细程度 – 4 或更大值会显示头信息， 3 或更大值可以显示响应代码(404, 200 等), 2 或更大值可以显示警告和其他信息。</p><p>-V 显示版本号并退出。<br>-C attribute Add cookie, eg. -C “c1=1234,c2=2,c3=3” (repeatable)<br>//-C cookie-name=value 对请求附加一个 Cookie:行。 其典型形式是 name=value 的一个参数对。此参数可以重复，用逗号分割。<br>提示：可以借助 session 实现原理传递 JSESSIONID 参数， 实现保持会话的功能，如-C ” c1=1234,c2=2,c3=3, JSESSIONID=FF056CD16DA9D71CB131C1D56F0319F8″ 。</p><p>-w Print out results in HTML tables //以 HTML 表的格式输出结果。默认时，它是白色背景的两列宽度的一张表。<br>-i Use HEAD instead of GET</p><ol start="4"><li><p>返回介绍<br>Document Path:测试页面<br>Document Length: 页面大小<br>Concurrency Level: 测试的并发数<br>Time taken for tests:整个测试持续的时间<br>Complete requests:完成的请求数量<br>Failed requests: 失败的请求数量<br>Write errors: 0<br>Total transferred: 整个过程中的网络传输量<br>HTML transferred: 整个过程中的 HTML 内容传输量<br>Requests per second: 最重要的指标之一，相当于 LR 中的每秒事务数，后面括号中的 mean 表示这是一个平均值<br>Time per request: 最重要的指标之二，相当于 LR 中的平均事务响应时间，后面括号中的 mean 表示这是一个平均值<br>Time per request: 每个连接请求实际运行时间的平均值<br>Transfer rate: 平均每秒网络上的流量，可以帮助排除是否存在网络流量过大导致响应时间延长的问题</p></li><li><p><a href="https://blog.csdn.net/weixin_39089928/article/details/87371792" target="_blank" rel="external nofollow noopener noreferrer">参考文档</a></p></li></ol><h2 id="jmeter"><a href="#jmeter" class="headerlink" title="jmeter"></a>jmeter</h2><ol><li><p>jmeter 简介<br>Apache JMeter 是 Apache 组织开发的基于 Java 的压力测试工具。用于对软件做压力测试，它最初被设计用于 Web 应用测试，但后来扩展到其他测试领域。 可以用于测试静态和动态资源，例如静态文件、CGI 脚本、Java 对象、数据库、FTP 服务器 等等。JMeter 可以用于对服务器、网络或对象模拟巨大的负载，来自不同压力类别下测试它们的强度和分析整体性能。</p></li><li><p>jmeter 安装<br>由于 Jmeter 是基于 java 开发，首先需要下载安装 JDK （目前 JMeter 只支持到 Java 8，尚不支持 Java 9）。<br>官网下载地址：<a href="http://jmeter.apache.org/download_jmeter.cgi" target="_blank" rel="external nofollow noopener noreferrer">http://jmeter.apache.org/download_jmeter.cgi</a><br>下载完成后解压 zip 包<br>启动 JMeter，双击 JMeter 解压路径（apache-jmeter-3.3\bin）bin 下面的 jmeter.bat 即可<br>Jmeter 是支持中文的，启动 Jmeter 后， 点击 Options -&gt; Choose Language 来选择语言</p></li><li><p>jmeter 使用<br>(1) 添加线程组<br>线程数：虚拟用户数，用于并发测试。<br>Ramp-Up Period(in seconds)准备时长：设置的虚拟用户数需要多长时间全部启动。如果线程数为 10，准备时长为 2，那么需要 2 秒钟启动 10 个线程，也就是每秒钟启动 5 个线程。<br>循环次数：每个线程发送请求的次数。如果线程数为 10，循环次数为 100，那么每个线程发送 100 次请求。总请求数为 10*100=1000 。如果勾选了“永远”，那么所有线程会一直发送请求，一到选择停止运行脚本。<br>(2) 在线程组下添加测试的请求类型，例如 http 请求、TCP 请求等，注意一些请求可能需要添加额外的插件才能实现（例如 UDP）。下面以常用的 http 请求为例。<br>协议：向目标服务器发送 HTTP 请求协议，可以是 HTTP 或 HTTPS，默认为 HTTP 。<br>服务器名称或 IP ：HTTP 请求发送的目标服务器名称或 IP 。<br>端口号：目标服务器的端口号，默认值为 80 。<br>方法：发送 HTTP 请求的方法，可用方法包括 GET、POST、HEAD、PUT、OPTIONS、TRACE、DELETE 等。<br>路径：目标 URL 路径（URL 中去掉服务器地址、端口及参数后剩余部分）<br>Content encoding ：编码方式，默认为 ISO-8859-1 编码，可以配置为 utf-8<br><img src="https://img-blog.csdnimg.cn/437d0dcc10164e89a29a4d987b5c845f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/d99e7674f1ff418e8c2043957d7fa41a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>（3）添加监听器-查看结果树</p></li><li><p>聚合报告详解：<br>Label：每个 JMeter 的 element（例如 HTTP Request）都有一个 Name 属性，这里显示的就是 Name 属性的值。<br>#Samples：请求数——表示这次测试中一共发出了多少个请求，如果模拟 10 个用户，每个用户迭代 10 次，那么这里显示 100。<br>Average：平均响应时间——默认情况下是单个 Request 的平均响应时间（ms），当使用了 Transaction Controller 时，以 Transaction 为单位显示平均响应时间。<br>Median：中位数，也就是 50％ 用户的响应时间<br>90% Line：90％ 用户的响应时间<br>Min：最小响应时间<br>Max：最大响应时间<br>Error%：错误率——错误请求数/请求总数<br>throughput：吞吐量——默认情况下表示每秒完成的请求数（Request per Second）<br>KB/Sec：每秒从服务器端接收到的数据量，相当于 LoadRunner 中的 Throughput/Sec</p></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Apache-Bench&quot;&gt;&lt;a href=&quot;#Apache-Bench&quot; class=&quot;headerlink&quot; title=&quot;Apache Bench&quot;&gt;&lt;/a&gt;Apache Bench&lt;/h2&gt;&lt;p&gt;Apache Bench 简介&lt;br&gt;ApacheBench 是 Apache 服务器自带的一个 web 压力测试工具，简称 ab。ab 又是一个命令行工具，对发起负载的本机要求很低，根据 ab 命令可以创建很多的并发访问线程，模拟多个访问者同时对某一 URL 地址进行访问，因此可以用来测试目标服务器的负载压力。总的来说 ab 工具小巧简单，上手学习较快，可以提供需要的基本性能指标，但是没有图形化结果，不能监控。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="压测工具" scheme="https://blog.wjc66.cn/tags/%E5%8E%8B%E6%B5%8B%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>git撤销commit中单个文件的修改</title>
    <link href="https://blog.wjc66.cn/git%E6%92%A4%E9%94%80commit%E4%B8%AD%E5%8D%95%E4%B8%AA%E6%96%87%E4%BB%B6%E7%9A%84%E4%BF%AE%E6%94%B9/"/>
    <id>https://blog.wjc66.cn/git%E6%92%A4%E9%94%80commit%E4%B8%AD%E5%8D%95%E4%B8%AA%E6%96%87%E4%BB%B6%E7%9A%84%E4%BF%AE%E6%94%B9/</id>
    <published>2021-12-01T05:28:22.000Z</published>
    <updated>2021-12-01T05:32:42.307Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>由于不小心提交了了 yarn.lock 文件，后面还 commit 了几次提交。现在只要回退 yarn.lock 的提交。</p><ol><li><p>先查询 yarn.lock 的提交记录<br><code>git log yarn.lock</code></p></li><li><p>找到这个文件的上次 commit id, 并对其进行 reset 操作<br><code>git reset &lt;commit-id&gt; yarn.lock</code></p></li><li><p>再撤销对此文件的修改<br><code>git checkout yarn.lock</code></p></li><li><p>重新 commit 提交就好<br><code>git commit -m &#39;&#39;</code><br><code>git push</code></p></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;问题&quot;&gt;&lt;a href=&quot;#问题&quot; class=&quot;headerlink&quot; title=&quot;问题&quot;&gt;&lt;/a&gt;问题&lt;/h2&gt;&lt;p&gt;由于不小心提交了了 yarn.lock 文件，后面还 commit 了几次提交。现在只要回退 yarn.lock 的提交。&lt;/p&gt;
&lt;ol&gt;
      
    
    </summary>
    
    
    
      <category term="git" scheme="https://blog.wjc66.cn/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>配置jdk与maven</title>
    <link href="https://blog.wjc66.cn/%E9%85%8D%E7%BD%AEjdk%E4%B8%8Emaven/"/>
    <id>https://blog.wjc66.cn/%E9%85%8D%E7%BD%AEjdk%E4%B8%8Emaven/</id>
    <published>2021-11-26T02:21:33.000Z</published>
    <updated>2021-11-26T02:23:12.872Z</updated>
    
    <content type="html"><![CDATA[<h2 id="安装与配置-jdk"><a href="#安装与配置-jdk" class="headerlink" title="安装与配置 jdk"></a>安装与配置 jdk</h2><ol><li><p>下载链接（<a href="https://www.oracle.com/java/technologies/downloads/#jdk17-windows）" target="_blank" rel="external nofollow noopener noreferrer">https://www.oracle.com/java/technologies/downloads/#jdk17-windows）</a><br>默认安装就好</p></li><li><p>配置环境变量<br>在系统变量里面增加<br><code>JAVA_HOME C:\Program Files\Java\jdk-17.0.1</code><br><code>Path %JAVA_HOME%\bin;%JAVA_HOME%\jre\bin;</code><br><code>CLASSPATH .;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar;</code></p></li></ol><a id="more"></a><ol start="3"><li>检验是否配置成功(如下就成功了)<br><img src="https://img-blog.csdnimg.cn/b767a02e41564a34acea65a65e491c40.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></li></ol><h2 id="安装与配置-maven"><a href="#安装与配置-maven" class="headerlink" title="安装与配置 maven"></a>安装与配置 maven</h2><ol><li><p>下载链接（<a href="https://maven.apache.org/download.cgi）" target="_blank" rel="external nofollow noopener noreferrer">https://maven.apache.org/download.cgi）</a><br><img src="https://img-blog.csdnimg.cn/100e624ae8ba497ca780550ce7aa8e72.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p></li><li><p>解压 并且创建 maven-local-repository 目录用于存储 jar 包</p></li><li><p>配置环境变量<br>在系统变量里面增加<br><code>Maven_Home D:\maven\apache-maven-3.8.4</code><br>Path 变量值增加 <code>%Maven_Home%\bin</code></p></li><li><p>检测是否配置成功 <code>mvn -v</code><br><img src="https://img-blog.csdnimg.cn/66f6977fc2544e919db721b2b6b9249f.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p></li><li><p>Maven 的配置<br>打开 settings.xml<br>本地仓库位置<br><code>&lt;localRepository&gt;D:\maven\maven-local-repository&lt;/localRepository&gt;</code></p></li></ol><!-- 配置中央仓库的镜像（改用：阿里云中央仓库镜像）--><pre><code>&lt;mirror&gt;  &lt;id&gt;alimaven&lt;/id&gt;  &lt;name&gt;aliyun-maven&lt;/name&gt;  &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;  &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public&lt;/url&gt;&lt;/mirror&gt;</code></pre><ol start="6"><li>IntelliJ IDEA 中使用 Maven<br><img src="https://img-blog.csdnimg.cn/849c3d4f1624456b9c24147d979c05a4.png?x-oss-process=image/watermark,type_ZHJvaWRzYW5zZmFsbGJhY2s,shadow_50,text_Q1NETiBAdy1rbG92ZXI=,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;安装与配置-jdk&quot;&gt;&lt;a href=&quot;#安装与配置-jdk&quot; class=&quot;headerlink&quot; title=&quot;安装与配置 jdk&quot;&gt;&lt;/a&gt;安装与配置 jdk&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;&lt;p&gt;下载链接（&lt;a href=&quot;https://www.oracle.com/java/technologies/downloads/#jdk17-windows）&quot; target=&quot;_blank&quot; rel=&quot;external nofollow noopener noreferrer&quot;&gt;https://www.oracle.com/java/technologies/downloads/#jdk17-windows）&lt;/a&gt;&lt;br&gt;默认安装就好&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;配置环境变量&lt;br&gt;在系统变量里面增加&lt;br&gt;&lt;code&gt;JAVA_HOME C:\Program Files\Java\jdk-17.0.1&lt;/code&gt;&lt;br&gt;&lt;code&gt;Path %JAVA_HOME%\bin;%JAVA_HOME%\jre\bin;&lt;/code&gt;&lt;br&gt;&lt;code&gt;CLASSPATH .;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar;&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
    
    </summary>
    
    
    
      <category term="java" scheme="https://blog.wjc66.cn/tags/java/"/>
    
  </entry>
  
  <entry>
    <title>buffer与stream互相转换</title>
    <link href="https://blog.wjc66.cn/buffer%E4%B8%8Estream%E4%BA%92%E7%9B%B8%E8%BD%AC%E6%8D%A2/"/>
    <id>https://blog.wjc66.cn/buffer%E4%B8%8Estream%E4%BA%92%E7%9B%B8%E8%BD%AC%E6%8D%A2/</id>
    <published>2021-10-25T10:07:30.000Z</published>
    <updated>2022-03-30T07:06:54.332Z</updated>
    
    <content type="html"><![CDATA[<ol><li>流到缓冲区</li></ol><p>第一个操作是将读取流转换为缓冲区。Streams 最有效的操作是将它们通过管道传输到另一个流。这在您不想增加内存使用量的文件系统访问中很常见。</p><p>但是，在处理 HTTP 请求时，您可能希望直接将响应流转换为 JSON 对象或解析 url 编码值。</p><p>为此，您将读取缓冲区 data 事件提供的数据。Streams 将提供一个字符串或一个缓冲区作为数据事件的值。这取决于 Buffer 是否有编码集。默认情况下，它会在 data 事件期间输出 Buffers 。</p><p>这意味着您可以执行以下操作以从流中读取。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">streamToBuffer</span>(<span class="params">stream</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> buffers = [];</span><br><span class="line">    stream.on(<span class="string">"error"</span>, reject);</span><br><span class="line">    stream.on(<span class="string">"data"</span>, (data) =&gt; buffers.push(data));</span><br><span class="line">    stream.on(<span class="string">"end"</span>, () =&gt; resolve(Buffer.concat(buffers)));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此函数获取流（可能来自 HTTP 或 FS 访问）。然后它将每个 Buffer 推送到一个 Buffer 数组中。当流被完全读取时，它会将所有这些 Buffers 与 Buffer.concat 结合起来。</p><p>这显然会对大流造成一些问题，但对于需要在应用程序的后续部分中转换并在内存中携带的小流来说，它非常有用。</p><ol start="2"><li>缓冲区到流<br>下一部分是将 Buffer 转换为流。当您想将数据通过管道传输到现有流中时，这很有用。</li></ol><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> Duplex = <span class="built_in">require</span>(<span class="string">"stream"</span>).Duplex;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bufferToStream</span>(<span class="params">buffer</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> stream = <span class="keyword">new</span> Duplex();</span><br><span class="line">  stream.push(buffer);</span><br><span class="line">  stream.push(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">return</span> stream;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此操作创建一个双工字符串并简单地将缓冲区写入其中。该流现在可以像通常的任何写入流一样使用。</p><p>文档：<br><a href="https://www.derpturkey.com/buffer-to-stream-in-node/" target="_blank" rel="external nofollow noopener noreferrer">缓冲到节点中的流</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ol&gt;
&lt;li&gt;流到缓冲区&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;第一个操作是将读取流转换为缓冲区。Streams 最有效的操作是将它们通过管道传输到另一个流。这在您不想增加内存使用量的文件系统访问中很常见。&lt;/p&gt;
&lt;p&gt;但是，在处理 HTTP 请求时，您可能希望直接将响应流转换为 J
      
    
    </summary>
    
    
    
      <category term="nodejs" scheme="https://blog.wjc66.cn/tags/nodejs/"/>
    
  </entry>
  
  <entry>
    <title>使用git出现过的问题</title>
    <link href="https://blog.wjc66.cn/%E4%BD%BF%E7%94%A8git%E5%87%BA%E7%8E%B0%E8%BF%87%E7%9A%84%E9%97%AE%E9%A2%98/"/>
    <id>https://blog.wjc66.cn/%E4%BD%BF%E7%94%A8git%E5%87%BA%E7%8E%B0%E8%BF%87%E7%9A%84%E9%97%AE%E9%A2%98/</id>
    <published>2021-09-23T07:28:19.000Z</published>
    <updated>2021-09-23T07:30:46.323Z</updated>
    
    <content type="html"><![CDATA[<ol><li>拉取代码出现下面问题<br><code>load pubkey &quot;/c/Users/klover/.ssh/id_rsa&quot;: invalid format</code><br>是因为公钥之前我换过名字，导致出现问题<br>执行修复公钥命令，解决问题<br><code>ssh-keygen -f ~/.ssh/id_rsa -y &gt; ~/.ssh/id_rsa.pub</code></li></ol>]]></content>
    
    <summary type="html">
    
      
      
        &lt;ol&gt;
&lt;li&gt;拉取代码出现下面问题&lt;br&gt;&lt;code&gt;load pubkey &amp;quot;/c/Users/klover/.ssh/id_rsa&amp;quot;: invalid format&lt;/code&gt;&lt;br&gt;是因为公钥之前我换过名字，导致出现问题&lt;br&gt;执行修复公钥命令，解
      
    
    </summary>
    
    
    
      <category term="git" scheme="https://blog.wjc66.cn/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>封装elementui的table组件</title>
    <link href="https://blog.wjc66.cn/%E5%B0%81%E8%A3%85elementui%E7%9A%84table%E7%BB%84%E4%BB%B6/"/>
    <id>https://blog.wjc66.cn/%E5%B0%81%E8%A3%85elementui%E7%9A%84table%E7%BB%84%E4%BB%B6/</id>
    <published>2021-09-03T01:45:17.000Z</published>
    <updated>2021-09-23T07:24:47.890Z</updated>
    
    <content type="html"><![CDATA[<h2 id="table-vue"><a href="#table-vue" class="headerlink" title="table.vue"></a>table.vue</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">  &lt;el-table</span><br><span class="line">    v-bind=<span class="string">"$props"</span></span><br><span class="line">    border</span><br><span class="line">    :header-cell-style=<span class="string">"&#123; 'text-align': 'center' &#125;"</span></span><br><span class="line">    style=<span class="string">"width: 100%"</span></span><br><span class="line">  &gt;</span><br><span class="line">    &lt;el-table-column</span><br><span class="line">      label=<span class="string">"序号"</span></span><br><span class="line">      width=<span class="string">"50"</span></span><br><span class="line">      align=<span class="string">"center"</span></span><br><span class="line">    &gt;</span><br><span class="line">      &lt;template slot-scope=<span class="string">"scope"</span>&gt;</span><br><span class="line">        &#123;&#123; scope.$index + <span class="number">1</span> &#125;&#125;</span><br><span class="line">      &lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>el-table-column&gt;</span><br><span class="line">    &lt;template v-<span class="keyword">for</span>=<span class="string">"(col, key) in tableColumns"</span>&gt;</span><br><span class="line">      &lt;el-table-column</span><br><span class="line">        :key=<span class="string">"key"</span></span><br><span class="line">        v-bind=<span class="string">"col"</span></span><br><span class="line">      /&gt;</span><br><span class="line">    &lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp">  &lt;/</span>el-table&gt;</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp">&lt;script lang="ts"&gt;</span></span><br><span class="line"><span class="regexp">import &#123; Vue, Component, Prop &#125; from 'vue-property-decorator'</span></span><br><span class="line"><span class="regexp">import &#123; Table &#125; from 'element-ui'</span></span><br><span class="line"><span class="regexp">export type Column = &#123;</span></span><br><span class="line"><span class="regexp">  label: string</span></span><br><span class="line"><span class="regexp">  prop?: string</span></span><br><span class="line"><span class="regexp">  width?: string</span></span><br><span class="line"><span class="regexp">  minWidth?: string</span></span><br><span class="line"><span class="regexp">  fixed?: string | boolean</span></span><br><span class="line"><span class="regexp">  align?: 'left' | 'center' | 'right'</span></span><br><span class="line"><span class="regexp">  formatter?: &#123; (row: any, col: any, value: any): unknown &#125;</span></span><br><span class="line"><span class="regexp">  /</span><span class="regexp">/ renderHeader的使用 https:/</span><span class="regexp">/www.cnblogs.com/yi</span>xiancheng/p/<span class="number">11525970.</span>html</span><br><span class="line">  renderHeader?: &#123; (h: <span class="built_in">any</span>, &#123; column, $index &#125;: <span class="built_in">any</span>): unknown &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  props: &#123;</span><br><span class="line">    ...(Table <span class="keyword">as</span> <span class="built_in">any</span>).props,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="keyword">extends</span> Vue &#123;</span><br><span class="line">    <span class="meta">@Prop</span>(&#123; <span class="keyword">default</span>: <span class="function"><span class="params">()</span> =&gt;</span> ([]) &#125;) tableColumns!: Column</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">&lt;Table</span><br><span class="line">        v-loading=<span class="string">"loadings.fetch"</span></span><br><span class="line">        :data=<span class="string">"tableData"</span></span><br><span class="line">        :table-columns=<span class="string">"tableColumns"</span></span><br><span class="line">      /&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123;</span><br><span class="line">  components: &#123; Pagination, Search, CreateCoupon, CreateAccountCoupon, Table &#125;,</span><br><span class="line">  name: <span class="string">'coupon'</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="keyword">extends</span> Vue &#123;</span><br><span class="line">  loadings = &#123; fetch: <span class="literal">false</span> &#125;</span><br><span class="line">  tableData: <span class="built_in">any</span> = []</span><br><span class="line"></span><br><span class="line">  <span class="comment">// table 列</span></span><br><span class="line">  <span class="keyword">get</span> tableColumns(): Column[] &#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">      &#123;</span><br><span class="line">        label: <span class="string">'创建人'</span>,</span><br><span class="line">        prop: <span class="string">'userInfo.nickname'</span>,</span><br><span class="line">        align: <span class="string">'center'</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        label: <span class="string">'主体名称'</span>,</span><br><span class="line">        align: <span class="string">'center'</span>,</span><br><span class="line">        formatter: <span class="function">(<span class="params">row: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.$createElement(CopyAccountTableColumnNew, &#123;</span><br><span class="line">            props: &#123;</span><br><span class="line">              align: <span class="string">'center'</span>,</span><br><span class="line">              <span class="string">'name-key'</span>: row?.accountInfo?.verifiedName,</span><br><span class="line">              <span class="string">'id-key'</span>: row?.accountInfo?.id,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        label: <span class="string">'来源'</span>,</span><br><span class="line">        align: <span class="string">'center'</span>,</span><br><span class="line">        formatter: <span class="function">(<span class="params">row: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.couponSourceEnumMap.get(row.source)</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        label: <span class="string">'类型'</span>,</span><br><span class="line">        align: <span class="string">'center'</span>,</span><br><span class="line">        formatter: <span class="function">(<span class="params">row: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.couponTypeEnumMap.get(row?.couponTemplate?.type)</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        label: <span class="string">'使用场景'</span>,</span><br><span class="line">        align: <span class="string">'center'</span>,</span><br><span class="line">        formatter: <span class="function">(<span class="params">row: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> row.couponTemplate.usage.map(<span class="function">(<span class="params">item: <span class="built_in">any</span></span>) =&gt;</span> <span class="keyword">this</span>.couponUsageEnumMap.get(item)).join(<span class="string">'|'</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        label: <span class="string">'折扣'</span>,</span><br><span class="line">        align: <span class="string">'center'</span>,</span><br><span class="line">        formatter: <span class="function">(<span class="params">row: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.convert(row)</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        label: <span class="string">'状态'</span>,</span><br><span class="line">        align: <span class="string">'center'</span>,</span><br><span class="line">        formatter: <span class="function">(<span class="params">row: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">this</span>.couponStatusMap.get(row.status)</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        label: <span class="string">'创建时间'</span>,</span><br><span class="line">        prop: <span class="string">'createTime'</span>,</span><br><span class="line">        align: <span class="string">'center'</span>,</span><br><span class="line">        formatter: <span class="function">(<span class="params">row: <span class="built_in">any</span>, col: <span class="built_in">any</span>, value: <span class="built_in">any</span></span>) =&gt;</span> <span class="keyword">this</span>.timeFormatter(row, col, value),</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        label: <span class="string">'过期时间'</span>,</span><br><span class="line">        prop: <span class="string">'expiredAt'</span>,</span><br><span class="line">        align: <span class="string">'center'</span>,</span><br><span class="line">        formatter: <span class="function">(<span class="params">row: <span class="built_in">any</span>, col: <span class="built_in">any</span>, value: <span class="built_in">any</span></span>) =&gt;</span> <span class="keyword">this</span>.timeFormatter(row, col, value),</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        label: <span class="string">'操作'</span>,</span><br><span class="line">        formatter: <span class="function">(<span class="params">row: <span class="built_in">any</span>, col: <span class="built_in">any</span>, value: <span class="built_in">any</span></span>) =&gt;</span> <span class="keyword">this</span>.tableBtn(row, col, value),</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  timeFormatter(row: <span class="built_in">any</span>, col: <span class="built_in">any</span>, value: <span class="built_in">string</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> moment(value).format(<span class="string">'YYYY-MM-DD HH:mm:ss'</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 操作按钮</span></span><br><span class="line"><span class="comment">   * 文档 https://vuejs.org/v2/guide/render-function.html#createElement-Arguments</span></span><br><span class="line"><span class="comment">   * @param row</span></span><br><span class="line"><span class="comment">   * @param col</span></span><br><span class="line"><span class="comment">   * @param value</span></span><br><span class="line"><span class="comment">   * @returns</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  tableBtn(row: <span class="built_in">any</span>, col: <span class="built_in">any</span>, value: <span class="built_in">any</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> h = <span class="keyword">this</span>.$createElement</span><br><span class="line">    <span class="keyword">return</span> h(</span><br><span class="line">      <span class="string">'el-button'</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        style: &#123;</span><br><span class="line">          fontSize: <span class="string">'18px;'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        props: &#123;</span><br><span class="line">          size: <span class="string">'mini'</span>,</span><br><span class="line">          plain: <span class="literal">true</span>,</span><br><span class="line">          <span class="keyword">type</span>: <span class="string">'text'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        on: &#123;</span><br><span class="line">          click: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.$router.push(&#123;</span><br><span class="line">              name: <span class="string">'couponRecords'</span>,</span><br><span class="line">              params: &#123;</span><br><span class="line">                accountCouponId: row?.id,</span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;)</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      [<span class="string">'使用详情'</span>],</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;table-vue&quot;&gt;&lt;a href=&quot;#table-vue&quot; class=&quot;headerlink&quot; title=&quot;table.vue&quot;&gt;&lt;/a&gt;table.vue&lt;/h2&gt;&lt;figure class=&quot;highlight ts&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;28&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;29&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;30&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;31&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;32&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;33&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;34&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;35&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;36&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;37&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;38&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;39&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;40&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;41&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;42&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;43&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;44&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;45&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;46&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;47&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;48&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;template&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;lt;el-table&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    v-bind=&lt;span class=&quot;string&quot;&gt;&quot;$props&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    border&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    :header-cell-style=&lt;span class=&quot;string&quot;&gt;&quot;&amp;#123; &#39;text-align&#39;: &#39;center&#39; &amp;#125;&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    style=&lt;span class=&quot;string&quot;&gt;&quot;width: 100%&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;el-table-column&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      label=&lt;span class=&quot;string&quot;&gt;&quot;序号&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      width=&lt;span class=&quot;string&quot;&gt;&quot;50&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      align=&lt;span class=&quot;string&quot;&gt;&quot;center&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;lt;template slot-scope=&lt;span class=&quot;string&quot;&gt;&quot;scope&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &amp;#123;&amp;#123; scope.$index + &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt; &amp;#125;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;lt;&lt;span class=&quot;regexp&quot;&gt;/template&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;    &amp;lt;/&lt;/span&gt;el-table-column&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;template v-&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt;=&lt;span class=&quot;string&quot;&gt;&quot;(col, key) in tableColumns&quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      &amp;lt;el-table-column&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        :key=&lt;span class=&quot;string&quot;&gt;&quot;key&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        v-bind=&lt;span class=&quot;string&quot;&gt;&quot;col&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;      /&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;lt;&lt;span class=&quot;regexp&quot;&gt;/template&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;  &amp;lt;/&lt;/span&gt;el-table&amp;gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;&lt;span class=&quot;regexp&quot;&gt;/template&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;&amp;lt;script lang=&quot;ts&quot;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;import &amp;#123; Vue, Component, Prop &amp;#125; from &#39;vue-property-decorator&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;import &amp;#123; Table &amp;#125; from &#39;element-ui&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;export type Column = &amp;#123;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;  label: string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;  prop?: string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;  width?: string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;  minWidth?: string&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;  fixed?: string | boolean&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;  align?: &#39;left&#39; | &#39;center&#39; | &#39;right&#39;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;  formatter?: &amp;#123; (row: any, col: any, value: any): unknown &amp;#125;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;regexp&quot;&gt;  /&lt;/span&gt;&lt;span class=&quot;regexp&quot;&gt;/ renderHeader的使用 https:/&lt;/span&gt;&lt;span class=&quot;regexp&quot;&gt;/www.cnblogs.com/yi&lt;/span&gt;xiancheng/p/&lt;span class=&quot;number&quot;&gt;11525970.&lt;/span&gt;html&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  renderHeader?: &amp;#123; (h: &lt;span class=&quot;built_in&quot;&gt;any&lt;/span&gt;, &amp;#123; column, $index &amp;#125;: &lt;span class=&quot;built_in&quot;&gt;any&lt;/span&gt;): unknown &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Component&lt;/span&gt;(&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  props: &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...(Table &lt;span class=&quot;keyword&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;built_in&quot;&gt;any&lt;/span&gt;).props,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;  &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; Vue &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;meta&quot;&gt;@Prop&lt;/span&gt;(&amp;#123; &lt;span class=&quot;keyword&quot;&gt;default&lt;/span&gt;: &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; =&amp;gt;&lt;/span&gt; ([]) &amp;#125;) tableColumns!: Column&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;lt;&lt;span class=&quot;regexp&quot;&gt;/script&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
    
      <category term="vue" scheme="https://blog.wjc66.cn/tags/vue/"/>
    
      <category term="element" scheme="https://blog.wjc66.cn/tags/element/"/>
    
  </entry>
  
  <entry>
    <title>typescript泛型的使用</title>
    <link href="https://blog.wjc66.cn/typescript%E6%B3%9B%E5%9E%8B%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>https://blog.wjc66.cn/typescript%E6%B3%9B%E5%9E%8B%E7%9A%84%E4%BD%BF%E7%94%A8/</id>
    <published>2021-08-06T10:07:58.000Z</published>
    <updated>2022-03-30T07:06:54.330Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Partial"><a href="#Partial" class="headerlink" title="Partial"></a>Partial</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Make all properties in T optional</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">type Partial&lt;T&gt; = &#123;</span><br><span class="line">  [P <span class="keyword">in</span> keyof T]?: T[P];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="keyof-指的是把我们一个对象里面的-键值对里的键【key】-给罗列取出来，并把它们联合起来形成一种联合类型"><a href="#keyof-指的是把我们一个对象里面的-键值对里的键【key】-给罗列取出来，并把它们联合起来形成一种联合类型" class="headerlink" title="keyof 指的是把我们一个对象里面的 键值对里的键【key】 给罗列取出来，并把它们联合起来形成一种联合类型"></a>keyof 指的是把我们一个对象里面的 键值对里的键【key】 给罗列取出来，并把它们联合起来形成一种联合类型</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">type QunYou = Person &amp; QunYouAttribute;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  QunYou = &#123;</span></span><br><span class="line"><span class="comment">    name: string;</span></span><br><span class="line"><span class="comment">    age: number;</span></span><br><span class="line"><span class="comment">    isLsp: boolean;</span></span><br><span class="line"><span class="comment">    sex: '男' | '女' | 0 | 1;</span></span><br><span class="line"><span class="comment">  &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">type QunYouKeys = keyof QunYou; <span class="comment">// "name" | "age" | "isLsp" | "sex"</span></span><br></pre></td></tr></table></figure><p><code>in</code> 又是什么</p><p>Partial<t> 里面的 P 充当了另一个泛型。</t></p><p>in 在这里充当一个遍历的作用</p><p>把 <code>keyof T</code> 进行一个个遍历并且每个都单独拿出来生成新的 “键值对”</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 内部就会变成这样</span></span><br><span class="line">type Partial&lt;T&gt; = &#123;</span><br><span class="line">  [P <span class="keyword">in</span> keyof T]?: T[P];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">type newQunyou = Partial&lt;QunYou&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ↓</span></span><br><span class="line">type Partial&lt;QunYou&gt; = &#123;</span><br><span class="line">  [P <span class="keyword">in</span> <span class="string">'name'</span> | <span class="string">'age'</span> | <span class="string">'isLsp'</span> | <span class="string">'sex'</span>]?: QunYou[P];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ↓</span></span><br><span class="line">type Partial = &#123;</span><br><span class="line">  name?: QunYou[<span class="string">"name"</span>];</span><br><span class="line">  age?: QunYou[<span class="string">"age"</span>];</span><br><span class="line">  isLsp?: QunYou[<span class="string">"isLsp"</span>];</span><br><span class="line">  sex?:QunYou[<span class="string">"sex"</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ↓</span></span><br><span class="line">type Partial = &#123;</span><br><span class="line">  name?: string;</span><br><span class="line">  age?: number;</span><br><span class="line">  isLsp?: boolean;</span><br><span class="line">  sex?: <span class="string">'男'</span> | <span class="string">'女'</span> | <span class="number">0</span> | <span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>所以这个 <code>Partial</code> 就达到我们的效果 【通过泛型让目标类型中的所有属性变为可选】</p><h2 id="Pick"><a href="#Pick" class="headerlink" title="Pick"></a>Pick</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * From T, pick a set of properties whose keys are in the union K</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">type Pick&lt;T, K extends keyof T&gt; = &#123;</span><br><span class="line">  [P <span class="keyword">in</span> K]: T[P];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>通过上面 <code>Partial</code> 讲解这个 <code>Pick</code> 相信大伙应该好理解很多了。</p><p>Pick 接收两个参数做泛型。</p><p>这里第二个泛型 K 后面跟着约束条件 K extends keyof T，</p><p>泛型 的 <code>extends</code>， 与后续 运算的 extends 需要稍微留心做个区分。 这次看 extends 在这里充当 类似于判断的 “约束” 角色</p><p>意思就是说 这个 K 必须 符合 keyof T 这个集合里面。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">type QunYou = Person &amp; QunYouAttribute;</span><br><span class="line"></span><br><span class="line">type QunYouOnlyLsp = Pick&lt;QunYou, <span class="string">'name'</span> | <span class="string">'isLsp'</span>&gt;;</span><br><span class="line"><span class="comment">// 内部就会变成这样</span></span><br><span class="line">type Pick&lt;T, K extends keyof T&gt; = &#123;</span><br><span class="line">    [P <span class="keyword">in</span> K]: T[P];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">type QunYouOnlyLsp = Pick&lt;QunYou, <span class="string">"name"</span> | <span class="string">"isLsp"</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ↓</span></span><br><span class="line"><span class="comment">// "name" | "isLsp"  是否包含在 K的集合里面？ 是的，符合要求</span></span><br><span class="line">type Pick&lt;QunYou, <span class="string">"name"</span> | <span class="string">"isLsp"</span>&gt; = &#123;</span><br><span class="line">  [P <span class="keyword">in</span> <span class="string">'name'</span> | <span class="string">'isLsp'</span>]: QunYou[P];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ↓</span></span><br><span class="line">type Pick = &#123;</span><br><span class="line">  name: string;</span><br><span class="line">  isLsp: boolean;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="Extract"><a href="#Extract" class="headerlink" title="Extract"></a>Extract</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Extract from T those types that are assignable to U</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">type Extract&lt;T, U&gt; = T extends U ? T : never;</span><br><span class="line"></span><br><span class="line">就是在一个对象中取出你想要的几个值</span><br><span class="line">Extract&lt;QunYou, <span class="string">'name'</span>&gt;</span><br></pre></td></tr></table></figure><h2 id="Omit-和-Exclude"><a href="#Omit-和-Exclude" class="headerlink" title="Omit 和 Exclude"></a>Omit 和 Exclude</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Exclude from T those types that are assignable to U</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">type Exclude&lt;T, U&gt; = T extends U ? never : T;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Construct a type with the properties of T except for those in type K.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">type Omit&lt;T, K extends keyof any&gt; = Pick&lt;T, Exclude&lt;keyof T, K&gt;&gt;;</span><br></pre></td></tr></table></figure><blockquote><p>这里是 运算的 extends 书接上面 的泛型 的 extends，在此处记得对比。</p></blockquote><p>同样扮演 “判断” 的角色， 但是 在所谓 “TS 中的三目运算符” 里面，</p><p>更像是一层 “过滤” 的作用。</p><p>我们依旧以上面的例子作为介绍</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">type QunYou = Person &amp; QunYouAttribute;</span><br><span class="line"></span><br><span class="line">type QunDaLao = Omit&lt;QunYou, <span class="string">'name'</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// type Omit&lt;T, K extends keyof any&gt; = Pick&lt;T, Exclude&lt;keyof T, K&gt;&gt;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ↓</span></span><br><span class="line">type QunDaLao = Pick&lt;QunYou, Exclude&lt;keyof T, K&gt;&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 主要观察Exclude</span></span><br><span class="line">type ExcludeKeys = Exclude&lt;keyof QunYou, <span class="string">"name"</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ↓    type Exclude&lt;T, U&gt; = T extends U ? never : T;</span></span><br><span class="line">type Exclude&lt;<span class="string">"name"</span> | <span class="string">"age"</span> | <span class="string">"isLsp"</span> | <span class="string">"sex"</span>, <span class="string">"name"</span>&gt;  =  T extends U ? never : T;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ↓ 继续观察， 它将这么去 “判断”</span></span><br><span class="line"><span class="comment">//  在  T extends U ? never : T; 里面</span></span><br><span class="line"><span class="comment">//  将 T 里面的联合类型逐个逐个 与 U 进行 约束判断</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  T 里面的 "name" 与 U 的 "name" (类型)符合吗？ 符合， 返回 never ，既 什么都没有。</span></span><br><span class="line"><span class="comment">//  T 里面的 "age" 与 U 的 "name" (类型)符合吗？ 不符合 返回 "age" 本身。</span></span><br><span class="line"><span class="comment">//  T 里面的 "isLsp" 与 U 的 "name" (类型)符合吗？ 不符合 返回 "isLsp" 本身。</span></span><br><span class="line"><span class="comment">//  T 里面的 "sex" 与 U 的 "name" (类型)符合吗？ 不符合 返回 "sex" 本身。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 所以 我们得到的结果就是 被 "过滤"后的 联合类型</span></span><br><span class="line">type ExcludeResult = <span class="string">"age"</span> | <span class="string">"isLsp"</span> | <span class="string">"sex"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 那么回过头继续看 Omit</span></span><br><span class="line">type QunDaLao = Pick&lt;QunYou, Exclude&lt;keyof T, K&gt;&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ↓</span></span><br><span class="line">type QunDaLao = Pick&lt;QunYou, <span class="string">"age"</span> | <span class="string">"isLsp"</span> | <span class="string">"sex"</span>&gt;</span><br><span class="line"><span class="comment">//  嗯？是不是很熟悉了，跟上面一样</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 所以 Omit 他的结果就达到了剔除  "name"的效果</span></span><br><span class="line">type QunDaLao = &#123;</span><br><span class="line">  age: number;</span><br><span class="line">  isLsp: boolean;</span><br><span class="line">  sex: <span class="string">'男'</span> | <span class="string">'女'</span> | <span class="number">0</span> | <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>最后 再聊一个 infer 与 typeof 关键字</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> qunYous: QunHaiXing[] = [];</span><br><span class="line"></span><br><span class="line">type whatIsQunYou&lt;T&gt; = T extends <span class="built_in">Array</span>&lt;infer V&gt; ? V : never;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newQunYou: whatIsQunYou&lt;<span class="keyword">typeof</span> qunYous&gt; = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>infer 的意思是待推导一个泛型，</p><p>在这里形容更像是一个 “标记”，</p><p>我在这里先把 V 给标记了，等下你们给我推出这个 V 的类型然后让我用！</p><p>注意看 typeof 的位置，他处在泛型的位置，</p><p>这将意味着 “Ts 的 typeof” 和 “Js 和 typeof” 不是一个东西。</p><p>在普通写运行代码的地方 typeof 是真的会运行并返回出一个变量的类型字符串。</p><p>但是写在类型地方的 typeof 仅起到一个静态类型的作用（既不会真的返回一个字符串出来）</p><p>那他在这里的作用是什么</p><p>还是同一个思想，只不过他在这里 typeof 返回的是 TS 里的类型</p><p>即</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> qunYous: QunHaiXing[] = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newQunYou: whatIsQunYou&lt;<span class="keyword">typeof</span> qunYous&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ↓</span></span><br><span class="line"><span class="keyword">const</span> newQunYou: whatIsQunYou&lt;<span class="built_in">Array</span>&lt;QunHaiXing&gt;&gt;;</span><br><span class="line"><span class="comment">// 或者是 whatIsQunYou&lt;QunHaiXing[]&gt;</span></span><br></pre></td></tr></table></figure><p>回过头继续看 whatIsQunYou 中 infer 的标记 是怎么标记法！</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">type whatIsQunYou&lt;T&gt; = T extends <span class="built_in">Array</span>&lt;infer V&gt; ? V : never;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> newQunYou: whatIsQunYou&lt;<span class="built_in">Array</span>&lt;QunHaiXing&gt;&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ↓</span></span><br><span class="line">type whatIsQunYou&lt; <span class="built_in">Array</span>&lt;QunHaiXing&gt; &gt; = <span class="built_in">Array</span>&lt;QunHaiXing&gt; extends <span class="built_in">Array</span>&lt;infer V&gt; ? V : never;</span><br><span class="line"></span><br><span class="line"><span class="comment">// T 里面的 Array&lt;QunHaiXing&gt; 与 Array&lt;infer V&gt; 类型是否符合吗？ 符合， 符合返回 V</span></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 等等！ V 是什么！！！</span></span><br><span class="line"><span class="comment">// ..</span></span><br><span class="line"><span class="comment">// 我们看看位置进行“对比”</span></span><br><span class="line"><span class="comment">// 我们用简单的语言进行概括。</span></span><br><span class="line"><span class="comment">// 把尖括号的位置 一样的！就赋值给 V！</span></span><br><span class="line"><span class="comment">// Array&lt;QunHaiXing&gt; 与 Array&lt;infer V&gt; 对比下</span></span><br><span class="line"><span class="comment">// 很明显 QunHaiXing 这个类型符合 V 的位置 所以把他赋值给V</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 重新来！！</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// T 里面的 Array&lt;QunHaiXing&gt; 与 Array&lt;infer V&gt; 类型是否符合吗？ 符合， 符合返回 QunHaiXing</span></span><br></pre></td></tr></table></figure><p>这就是 infer 具有推导作用的关键字。</p><h2 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h2><p><a href="https://zhuanlan.zhihu.com/p/361968852" target="_blank" rel="external nofollow noopener noreferrer">文章来源</a></p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 冻结客户类型</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">enum</span> BlockOrUnblockCustomerActionEnum &#123;</span><br><span class="line">  <span class="comment">/** 永久冻结 */</span></span><br><span class="line">  TEMPORARY_BLOCK = <span class="string">'TEMPORARY_BLOCK'</span>,</span><br><span class="line">  <span class="comment">/** 临时冻结 */</span></span><br><span class="line">  PERMANENT_BLOCK = <span class="string">'PERMANENT_BLOCK'</span>,</span><br><span class="line">  <span class="comment">/** 解冻 */</span></span><br><span class="line">  UNBLOCK = <span class="string">'UNBLOCK'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 冻结客户理由</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">enum</span> BlockOrUnblockCustomerReasonEnum &#123;</span><br><span class="line">  CUSTOMER_REQUEST = <span class="string">'CUSTOMER_REQUEST'</span>,</span><br><span class="line">  CLIENT_REQUEST = <span class="string">'CLIENT_REQUEST'</span>,</span><br><span class="line">  DECEASED = <span class="string">'DECEASED'</span>,</span><br><span class="line">  ACCOUNT_CLOSURE = <span class="string">'ACCOUNT_CLOSURE'</span>,</span><br><span class="line">  SUSPICIOUS_ACTIVITY = <span class="string">'SUSPICIOUS_ACTIVITY'</span>,</span><br><span class="line">  FRAUDULENT_ACTIVITY = <span class="string">'FRAUDULENT_ACTIVITY'</span>,</span><br><span class="line">  POTENTIAL_SANCTION = <span class="string">'POTENTIAL_SANCTION'</span>,</span><br><span class="line">  SANCTIONED_CUSTOMER = <span class="string">'SANCTIONED_CUSTOMER'</span>,</span><br><span class="line">  BLACKLISTED_CUSTOMER = <span class="string">'BLACKLISTED_CUSTOMER'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> IBlockOrUnblockCustomerReason = &#123;</span><br><span class="line">  [BlockOrUnblockCustomerActionEnum.PERMANENT_BLOCK]: BlockOrUnblockCustomerReasonEnum;</span><br><span class="line">  [BlockOrUnblockCustomerActionEnum.TEMPORARY_BLOCK]: Extract&lt;</span><br><span class="line">    BlockOrUnblockCustomerReasonEnum,</span><br><span class="line">    | BlockOrUnblockCustomerReasonEnum.CUSTOMER_REQUEST</span><br><span class="line">    | BlockOrUnblockCustomerReasonEnum.CLIENT_REQUEST</span><br><span class="line">    | BlockOrUnblockCustomerReasonEnum.SUSPICIOUS_ACTIVITY</span><br><span class="line">    | BlockOrUnblockCustomerReasonEnum.POTENTIAL_SANCTION</span><br><span class="line">  &gt;;</span><br><span class="line">  [BlockOrUnblockCustomerActionEnum.UNBLOCK]: Extract&lt;</span><br><span class="line">    BlockOrUnblockCustomerReasonEnum,</span><br><span class="line">    BlockOrUnblockCustomerReasonEnum.CUSTOMER_REQUEST | BlockOrUnblockCustomerReasonEnum.CLIENT_REQUEST</span><br><span class="line">  &gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> BlockOrUnblockCustomerInput&lt;K <span class="keyword">extends</span> BlockOrUnblockCustomerActionEnum, T <span class="keyword">extends</span> IBlockOrUnblockCustomerReason&gt; = &#123;</span><br><span class="line">  <span class="comment">// 冻结类型</span></span><br><span class="line">  action: K;</span><br><span class="line">  <span class="comment">// 理由</span></span><br><span class="line">  reason: T[K];</span><br><span class="line">  <span class="comment">// 自定义</span></span><br><span class="line">  comment?: <span class="built_in">string</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">async</span> blockOrUnblockCustomer&lt;K <span class="keyword">extends</span> BlockOrUnblockCustomerActionEnum, T <span class="keyword">extends</span> IBlockOrUnblockCustomerReason&gt;(</span><br><span class="line">    customerHashId: <span class="built_in">string</span>,</span><br><span class="line">    dataParams: BlockOrUnblockCustomerInput&lt;K, T&gt;,</span><br><span class="line">  ) &#123;&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;Partial&quot;&gt;&lt;a href=&quot;#Partial&quot; class=&quot;headerlink&quot; title=&quot;Partial&quot;&gt;&lt;/a&gt;Partial&lt;/h2&gt;&lt;figure class=&quot;highlight js&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gu
      
    
    </summary>
    
    
    
      <category term="typescript" scheme="https://blog.wjc66.cn/tags/typescript/"/>
    
  </entry>
  
</feed>
